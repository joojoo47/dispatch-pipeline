{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "378b37c1",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üîÑ Installing dashboard dependencies...\n",
      "This may take a minute or two...\n",
      "\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m25.1.1\u001b[0m\u001b[39;49m -> \u001b[0m\u001b[32;49m25.2\u001b[0m\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpython -m pip install --upgrade pip\u001b[0m\n",
      "\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m25.1.1\u001b[0m\u001b[39;49m -> \u001b[0m\u001b[32;49m25.2\u001b[0m\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpython -m pip install --upgrade pip\u001b[0m\n",
      "Note: you may need to restart the kernel to use updated packages.\n",
      "‚úÖ Dependencies installed successfully!\n",
      "üéâ Ready for the next step!\n",
      "Note: you may need to restart the kernel to use updated packages.\n",
      "‚úÖ Dependencies installed successfully!\n",
      "üéâ Ready for the next step!\n"
     ]
    }
   ],
   "source": [
    "# Install required packages\n",
    "print(\"üîÑ Installing dashboard dependencies...\")\n",
    "print(\"This may take a minute or two...\")\n",
    "%pip install ipywidgets requests pandas plotly python-dotenv tabulate --quiet\n",
    "\n",
    "print(\"‚úÖ Dependencies installed successfully!\")\n",
    "print(\"üéâ Ready for the next step!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fe5937fd",
   "metadata": {},
   "source": [
    "# üöÄ N8N Admin Dashboard\n",
    "\n",
    "Welcome to your comprehensive N8N administration and monitoring dashboard! This interactive notebook provides powerful tools to manage, monitor, and troubleshoot your N8N automation workflows.\n",
    "\n",
    "## üéØ What You Can Do\n",
    "\n",
    "- **System Monitoring**: Check N8N health, database connectivity, and system status\n",
    "- **Configuration Management**: Easily update connection settings and API keys\n",
    "- **Workflow Analytics**: View execution metrics, success rates, and performance data\n",
    "- **Error Diagnostics**: Monitor failed executions and troubleshoot issues\n",
    "- **Webhook Testing**: Test your webhook endpoints directly from the dashboard\n",
    "- **Workflow Control**: Activate/deactivate workflows and manage your automation pipeline\n",
    "\n",
    "## üìã Quick Start Guide\n",
    "\n",
    "1. **Configure Connection** (Required First Step)\n",
    "   - Enter your N8N URL and API key in the configuration section below\n",
    "   - Click \"Update & Verify\" to test the connection\n",
    "\n",
    "2. **Explore Features**\n",
    "   - Run cells in order to access different dashboard sections\n",
    "   - Each section is self-contained with clear instructions\n",
    "\n",
    "3. **Monitor & Manage**\n",
    "   - Use the status checks to ensure everything is working\n",
    "   - Review metrics and logs to optimize your workflows\n",
    "\n",
    "## üîß Requirements\n",
    "\n",
    "- ‚úÖ N8N instance running (yours is at: `https://n8n-clean-deploy.fly.dev`)\n",
    "- ‚úÖ API key created in N8N settings\n",
    "- ‚úÖ Internet connection for API calls\n",
    "\n",
    "---\n",
    "**Ready to get started? Run the next cell to install required packages!**"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b8e614c2",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "üîÑ Loading dashboard components...\n",
      "‚úÖ Dashboard components loaded!\n",
      "‚úÖ Configuration initialized!\n",
      "üîó Default N8N URL: https://n8n-dispatch.fly.dev\n",
      "üîë API Key: ‚ùå Not set (configure below)\n"
     ]
    }
   ],
   "source": [
    "# Import required libraries\n",
    "print(\"üîÑ Loading dashboard components...\")\n",
    "import os\n",
    "import requests\n",
    "import pandas as pd\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output, HTML\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "import json\n",
    "import time\n",
    "\n",
    "print(\"‚úÖ Dashboard components loaded!\")\n",
    "\n",
    "# --- Configuration ---\n",
    "# Load environment variables (from a local .env file)\n",
    "load_dotenv()\n",
    "\n",
    "# N8N API Configuration\n",
    "N8N_URL = os.getenv('N8N_URL', 'https://n8n-clean-deploy.fly.dev')  # Default to deployed instance\n",
    "N8N_API_KEY = os.getenv('N8N_API_KEY', '')  # Will be set through the Configuration Manager\n",
    "\n",
    "# Define headers for API calls\n",
    "headers = {'X-N8N-API-KEY': N8N_API_KEY}\n",
    "\n",
    "print(\"‚úÖ Configuration initialized!\")\n",
    "print(f\"üîó Default N8N URL: {N8N_URL}\")\n",
    "print(\"üîë API Key: \" + (\"‚úÖ Set\" if N8N_API_KEY else \"‚ùå Not set (configure below)\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b3921410",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "c1464c15a71b41cf8fc38cb6f48921b2",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "HTML(value='\\n    <div style=\"background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;\">\\n     ‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Progress tracking for user experience\n",
    "progress_sections = {\n",
    "    'configuration': False,\n",
    "    'system_check': False,\n",
    "    'concurrency': False,\n",
    "    'metrics': False,\n",
    "    'webhooks': False,\n",
    "    'diagnostics': False\n",
    "}"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "371151fa",
   "metadata": {},
   "source": [
    "## üß≠ Quick Navigation\n",
    "\n",
    "Jump to any section of the dashboard:\n",
    "\n",
    "| Section | Description | Status |\n",
    "|---------|-------------|--------|\n",
    "| [‚öôÔ∏è Configuration](#configuration) | Set up N8N connection | üîÑ Required First |\n",
    "| [üìä System Health](#system-health) | Check N8N & database status | ‚úÖ Ready |\n",
    "| [‚ö° Concurrency Watchdog](#concurrency-watchdog) | Monitor workflow concurrency | ‚úÖ Ready |\n",
    "| [üóÑÔ∏è Database Management](#database-management) | PostgreSQL migration tools | ‚úÖ Ready |\n",
    "| [üìà Analytics](#analytics) | View workflow metrics | ‚úÖ Ready |\n",
    "| [üîó Webhook Testing](#webhooks) | Test webhook endpoints | ‚úÖ Ready |\n",
    "| [üö® Error Monitoring](#diagnostics) | Monitor failed executions | ‚úÖ Ready |\n",
    "| [üéâ Summary](#summary) | Review & next steps | ‚úÖ Ready |\n",
    "\n",
    "---\n",
    "**üí° Pro Tip**: Complete sections in order for the best experience!"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9ed423dd",
   "metadata": {},
   "outputs": [
    {
     "ename": "SyntaxError",
     "evalue": "'(' was never closed (1910436982.py, line 32)",
     "output_type": "error",
     "traceback": [
      "  \u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 32\u001b[39m\n\u001b[31m    \u001b[39m\u001b[31mprint(\"‚úÖ API connection successful!\"                print(f\"üìä Found {workflow_count} workflows in your instance\")\u001b[39m\n         ^\n\u001b[31mSyntaxError\u001b[39m\u001b[31m:\u001b[39m '(' was never closed\n"
     ]
    }
   ],
   "source": [
    "            if api_response.status_code == 200:\n",
    "                workflow_count = len(api_response.json())\n",
    "                print(\"‚úÖ API connection successful!\")\n",
    "                print(f\"üìä Found {workflow_count} workflows in your instance\")\n",
    "                print(\"\\nüéâ Configuration complete! You can now use all dashboard features.\")\n",
    "                print(\"üí° Try running the System Health Check next!\")\n",
    "\n",
    "                # Mark configuration as complete\n",
    "                progress_sections['configuration'] = True"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3379a05a",
   "metadata": {},
   "source": [
    "# ‚öôÔ∏è 1. Configuration Setup {#configuration}\n",
    "\n",
    "**Status**: üîÑ Not Configured Yet\n",
    "\n",
    "This is the **most important step** - you must configure your connection to N8N before using any other features."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "22003861",
   "metadata": {},
   "source": [
    "## üöÄ Quick Actions\n",
    "\n",
    "**After configuration, try these one-click actions:**\n",
    "\n",
    "- **üîç Run System Check**: Verify everything is working\n",
    "- **üìä View Dashboard**: See all metrics at once\n",
    "- **üîÑ Refresh Data**: Update all information\n",
    "\n",
    "---\n",
    "**Ready? Configure your connection below and start exploring!**"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "6c200bc5",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ System health check functions loaded!\n",
      "üí° Run display_system_status() after setting your API key in the configuration section above.\n"
     ]
    }
   ],
   "source": [
    "def check_n8n_status():\n",
    "    \"\"\"Check if n8n is accessible and running\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/healthz\", timeout=5)\n",
    "        if response.status_code == 200:\n",
    "            return True, \"N8N is running normally\"\n",
    "        return False, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database():\n",
    "    \"\"\"Check database connection via API key access\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        return False, \"API Key is not set.\"\n",
    "\n",
    "    try:\n",
    "        # Try workflows endpoint first\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/workflows?limit=1\",\n",
    "                                headers={'X-N8N-API-KEY': N8N_API_KEY}, timeout=5)\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working (Workflows accessible)\"\n",
    "        elif response.status_code == 401:\n",
    "            # API key exists but may have limited permissions\n",
    "            # Try executions endpoint as alternative\n",
    "            exec_response = requests.get(f\"{N8N_URL}/api/v1/executions?limit=1\",\n",
    "                                       headers={'X-N8N-API-KEY': N8N_API_KEY}, timeout=5)\n",
    "            if exec_response.status_code == 200:\n",
    "                return True, \"API key valid (Executions accessible, limited workflow permissions)\"\n",
    "            else:\n",
    "                return False, f\"API Key Unauthorized (401) - Check permissions in n8n settings\"\n",
    "        elif response.status_code == 403:\n",
    "            return False, \"API Key Forbidden (403) - Insufficient permissions\"\n",
    "        else:\n",
    "            return False, f\"API check failed: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "def display_system_status():\n",
    "    \"\"\"Display system status in a formatted way\"\"\"\n",
    "    print(\"üîç Running system health checks...\")\n",
    "    n8n_status, n8n_msg = check_n8n_status()\n",
    "    db_status, db_msg = check_database()\n",
    "\n",
    "    status_df = pd.DataFrame({\n",
    "        'Component': ['N8N Service', 'Persistence (DB)'],\n",
    "        'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "                   'üü¢ Connected' if db_status else 'üî¥ Disconnected'],\n",
    "        'Message': [n8n_msg, db_msg]\n",
    "    })\n",
    "\n",
    "    display(status_df)\n",
    "\n",
    "    # Update progress\n",
    "    global progress_sections\n",
    "    progress_sections['system_check'] = n8n_status and db_status\n",
    "\n",
    "    if n8n_status and db_status:\n",
    "        print(\"\\n‚úÖ System health check completed successfully!\")\n",
    "        print(\"üí° Your N8N instance and database are both healthy.\")\n",
    "    else:\n",
    "        print(\"\\n‚ö†Ô∏è Some systems need attention - check the status table above.\")\n",
    "\n",
    "    return status_df\n",
    "\n",
    "# System status functions are now ready\n",
    "# Run display_system_status() manually after configuring your API key above\n",
    "print(\"‚úÖ System health check functions loaded!\")\n",
    "print(\"üí° Run display_system_status() after setting your API key in the configuration section above.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6dbb36fe",
   "metadata": {},
   "source": [
    "# üìä 2. System Health Check {#system-health}\n",
    "\n",
    "**Status**: üîÑ Run this after configuration"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "2be8fb70",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "‚úÖ API key configured successfully!\n"
     ]
    },
    {
     "ename": "NameError",
     "evalue": "name 'N8N_URL' is not defined",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mNameError\u001b[39m                                 Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[7]\u001b[39m\u001b[32m, line 6\u001b[39m\n\u001b[32m      3\u001b[39m headers = {\u001b[33m'\u001b[39m\u001b[33mX-N8N-API-KEY\u001b[39m\u001b[33m'\u001b[39m: N8N_API_KEY}\n\u001b[32m      5\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[33m‚úÖ API key configured successfully!\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m----> \u001b[39m\u001b[32m6\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33müîó N8N URL: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00m\u001b[43mN8N_URL\u001b[49m\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n\u001b[32m      7\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[33müîë API Key: ‚úÖ Set and ready\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m      8\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33m\"\u001b[39m\u001b[38;5;130;01m\\n\u001b[39;00m\u001b[33müîç Running system health check...\u001b[39m\u001b[33m\"\u001b[39m)\n",
      "\u001b[31mNameError\u001b[39m: name 'N8N_URL' is not defined"
     ]
    }
   ],
   "source": [
    "# Direct API key configuration\n",
    "N8N_API_KEY = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI3Y2M1OGNlMC00NmMxLTQ2OTQtYjI3OC1jMjI5MTdjYWViY2UiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzYwNTUwMTAxfQ.NiADusdZUVI_1fp2LcEUAt8JAA2bUTpqgcxPOx0oPNg\"\n",
    "headers = {'X-N8N-API-KEY': N8N_API_KEY}\n",
    "\n",
    "print(\"‚úÖ API key configured successfully!\")\n",
    "print(f\"üîó N8N URL: {N8N_URL}\")\n",
    "print(\"üîë API Key: ‚úÖ Set and ready\")\n",
    "print(\"\\nüîç Running system health check...\")\n",
    "\n",
    "# Run system status check\n",
    "display_system_status()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "21c100ca",
   "metadata": {},
   "source": [
    "# üìà 3. Workflow Analytics & Metrics {#analytics}\n",
    "\n",
    "**Status**: \udd04 Run after configuration"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d7890426",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_execution_metrics():\n",
    "    \"\"\"Fetch and analyze workflow execution metrics\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        print(\"‚ùå API Key required for metrics.\")\n",
    "        return pd.DataFrame()\n",
    "        \n",
    "    try:\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/executions\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY},\n",
    "            params={'limit': 100} \n",
    "        )\n",
    "        if response.status_code != 200:\n",
    "            print(f\"‚ùå Failed to fetch executions: Status {response.status_code}\")\n",
    "            return pd.DataFrame()\n",
    "        \n",
    "        executions = response.json().get('data', [])\n",
    "        execution_data = []\n",
    "        \n",
    "        for exec in executions:\n",
    "            execution_data.append({\n",
    "                'Workflow': exec.get('workflowName', 'N/A'),\n",
    "                'Status': exec.get('status'),\n",
    "                'Duration_s': exec.get('duration', 0) / 1000,  # Convert ms to seconds\n",
    "                'Timestamp': datetime.fromisoformat(exec.get('startedAt').replace('Z', '+00:00')).strftime('%Y-%m-%d %H:%M')\n",
    "            })\n",
    "        \n",
    "        return pd.DataFrame(execution_data)\n",
    "    except Exception as e:\n",
    "        print(f\"‚ùå Error fetching metrics: {str(e)}\")\n",
    "        return pd.DataFrame()\n",
    "\n",
    "def plot_execution_metrics():\n",
    "    \"\"\"Create visualizations for execution metrics\"\"\"\n",
    "    df = get_execution_metrics()\n",
    "    if df.empty:\n",
    "        return\n",
    "    \n",
    "    # Calculate Success/Failure Counts\n",
    "    status_counts = df.groupby('Status').size().reset_index(name='Count')\n",
    "    fig1 = px.pie(\n",
    "        status_counts,\n",
    "        values='Count',\n",
    "        names='Status',\n",
    "        title='Last 100 Executions Status Breakdown',\n",
    "        color_discrete_map={'success':'green', 'failed':'red', 'running':'blue'}\n",
    "    )\n",
    "    \n",
    "    # Average duration by workflow\n",
    "    fig2 = px.bar(\n",
    "        df.groupby('Workflow')['Duration_s'].mean().reset_index(),\n",
    "        x='Workflow',\n",
    "        y='Duration_s',\n",
    "        title='Average Execution Duration (seconds)',\n",
    "        labels={'Duration_s': 'Average Duration (s)'}\n",
    "    )\n",
    "    \n",
    "    fig1.show()\n",
    "    fig2.show()\n",
    "\n",
    "# Display metrics\n",
    "plot_execution_metrics()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ef59b0e6",
   "metadata": {},
   "source": [
    "# üîó 4. Webhook Testing Tools {#webhooks}\n",
    "\n",
    "**Status**: \udd04 Run after configuration"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f4eed0d9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "5e93e1886383455aa61b1b6bacc3abb3",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Text(value='', description='Webhook URL:', layout=Layout(width='80%'), placeholder='e.g., https://n8n.app/webh‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "7592ccd2931b4dc7b0b4df498c2d0d79",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Textarea(value='{\\n  \"data\": \"test_payload\"\\n}', description='Payload (JSON):', layout=Layout(height='150px', ‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "76616b22e4b24ef2895c7653313ee07a",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Button(button_style='primary', description='Test Webhook', style=ButtonStyle())"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "dc1850c9026244a48864bf995bf1302f",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Output()"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def test_webhook(webhook_url, payload=None):\n",
    "    \"\"\"Test a webhook endpoint\"\"\"\n",
    "    try:\n",
    "        payload = payload or {\"test\": True, \"timestamp\": datetime.now().isoformat()}\n",
    "        response = requests.post(webhook_url, json=payload, timeout=10)\n",
    "        return {\n",
    "            'Status Code': response.status_code,\n",
    "            'Response': response.text,\n",
    "            'Headers': dict(response.headers)\n",
    "        }\n",
    "    except Exception as e:\n",
    "        return {'Error': str(e)}\n",
    "\n",
    "webhook_url_input = widgets.Text(\n",
    "    description='Webhook URL:',\n",
    "    placeholder='e.g., https://n8n.app/webhook-test/...',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%'}\n",
    ")\n",
    "\n",
    "payload_input = widgets.Textarea(\n",
    "    description='Payload (JSON):',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%', 'height': '150px'},\n",
    "    value=json.dumps({\"data\": \"test_payload\"}, indent=2) \n",
    ")\n",
    "\n",
    "test_output = widgets.Output()\n",
    "\n",
    "def test_webhook_button_clicked(button):\n",
    "    with test_output:\n",
    "        clear_output(wait=True)\n",
    "        try:\n",
    "            payload = json.loads(payload_input.value)\n",
    "        except:\n",
    "            print(\"‚ùå Invalid JSON payload\")\n",
    "            return\n",
    "        \n",
    "        print(\"üîÑ Testing webhook...\")\n",
    "        result = test_webhook(webhook_url_input.value, payload)\n",
    "        print(\"\\nResults:\")\n",
    "        print(json.dumps(result, indent=2))\n",
    "\n",
    "test_button = widgets.Button(\n",
    "    description='Test Webhook',\n",
    "    button_style='primary'\n",
    ")\n",
    "test_button.on_click(test_webhook_button_clicked)\n",
    "\n",
    "# Display testing interface\n",
    "display(webhook_url_input, payload_input, test_button, test_output)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "565be387",
   "metadata": {},
   "source": [
    "# üö® 5. Error Monitoring & Diagnostics {#diagnostics}\n",
    "\n",
    "**Status**:  Run after configuration"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "be6b6044",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "d51721a272264b8996cb1955dc5599c9",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Button(button_style='warning', description='Refresh Failed Executions', style=ButtonStyle())"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "6daa5c9390334ba8b7cbafaf63e515f1",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Output()"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def get_failed_executions():\n",
    "    \"\"\"Fetch recent executions and filter for 'failed' status.\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        print(\"‚ùå API Key required for diagnostics.\")\n",
    "        return pd.DataFrame(columns=['ID', 'Workflow', 'Status', 'Started At'])\n",
    "        \n",
    "    try:\n",
    "        # Fetch up to 100 recent executions\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/executions\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY},\n",
    "            params={'limit': 100, 'sort': 'id', 'sortOrder': 'DESC'}\n",
    "        )\n",
    "        response.raise_for_status() # Raise HTTPError for bad responses (4xx or 5xx)\n",
    "        \n",
    "        executions = response.json().get('data', [])\n",
    "        \n",
    "        failed_data = []\n",
    "        for exec in executions:\n",
    "            if exec.get('status') == 'failed':\n",
    "                failed_data.append({\n",
    "                    'ID': exec.get('id'),\n",
    "                    'Workflow': exec.get('workflowName', 'N/A'),\n",
    "                    'Status': 'üî¥ FAILED',\n",
    "                    'Started At': datetime.fromisoformat(exec.get('startedAt').replace('Z', '+00:00')).strftime('%Y-%m-%d %H:%M:%S'),\n",
    "                    'Error Message': exec.get('error', {}).get('message', 'No error message available')\n",
    "                })\n",
    "        \n",
    "        df = pd.DataFrame(failed_data)\n",
    "        if df.empty:\n",
    "            print(\"‚úÖ No failed executions found in the last 100 runs.\")\n",
    "            return pd.DataFrame()\n",
    "        \n",
    "        return df[['ID', 'Workflow', 'Status', 'Started At', 'Error Message']]\n",
    "        \n",
    "    except requests.exceptions.RequestException as e:\n",
    "        print(f\"‚ùå Connection Error: {str(e)}\")\n",
    "    except Exception as e:\n",
    "        print(f\"‚ùå Diagnostic Error: {str(e)}\")\n",
    "        \n",
    "    return pd.DataFrame()\n",
    "\n",
    "# Create an output widget for failed executions\n",
    "failed_executions_output = widgets.Output()\n",
    "\n",
    "def refresh_failed_executions(button=None):\n",
    "    with failed_executions_output:\n",
    "        clear_output(wait=True)\n",
    "        print(\"üîÑ Fetching failed executions...\")\n",
    "        df = get_failed_executions()\n",
    "        if not df.empty:\n",
    "            display(df)\n",
    "\n",
    "refresh_button = widgets.Button(\n",
    "    description='Refresh Failed Executions',\n",
    "    button_style='warning'\n",
    ")\n",
    "refresh_button.on_click(refresh_failed_executions)\n",
    "\n",
    "# Display the refresh button and output area\n",
    "display(refresh_button)\n",
    "display(failed_executions_output)\n",
    "\n",
    "# Initial load of failed executions\n",
    "refresh_failed_executions()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1131ccc0",
   "metadata": {},
   "source": [
    "# N8N Admin Dashboard\n",
    "\n",
    "This dashboard provides comprehensive monitoring and management capabilities for your n8n instance. It includes:\n",
    "\n",
    "1. System Status Monitoring\n",
    "2. Configuration Management\n",
    "3. API Testing\n",
    "4. User Management\n",
    "5. Workflow Status\n",
    "\n",
    "## Setup and Requirements\n",
    "\n",
    "First, let's install the required packages:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "698ec00e",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Requirement already satisfied: requests in /home/codespace/.local/lib/python3.12/site-packages (2.32.5)\n",
      "Requirement already satisfied: pandas in /home/codespace/.local/lib/python3.12/site-packages (2.3.3)\n",
      "Requirement already satisfied: plotly in /home/codespace/.local/lib/python3.12/site-packages (6.3.1)\n",
      "Requirement already satisfied: flask-login in /usr/local/python/3.12.1/lib/python3.12/site-packages (0.6.3)\n",
      "Requirement already satisfied: sqlalchemy in /usr/local/python/3.12.1/lib/python3.12/site-packages (2.0.44)\n",
      "Requirement already satisfied: python-dotenv in /home/codespace/.local/lib/python3.12/site-packages (1.1.1)\n",
      "Requirement already satisfied: charset_normalizer<4,>=2 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (3.4.2)\n",
      "Requirement already satisfied: idna<4,>=2.5 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (3.10)\n",
      "Requirement already satisfied: urllib3<3,>=1.21.1 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (2.5.0)\n",
      "Requirement already satisfied: certifi>=2017.4.17 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (2025.7.9)\n",
      "Requirement already satisfied: numpy>=1.26.0 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2.3.1)\n",
      "Requirement already satisfied: python-dateutil>=2.8.2 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2.9.0.post0)\n",
      "Requirement already satisfied: pytz>=2020.1 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2025.2)\n",
      "Requirement already satisfied: tzdata>=2022.7 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2025.2)\n",
      "Requirement already satisfied: narwhals>=1.15.1 in /home/codespace/.local/lib/python3.12/site-packages (from plotly) (1.46.0)\n",
      "Requirement already satisfied: packaging in /home/codespace/.local/lib/python3.12/site-packages (from plotly) (25.0)\n",
      "Requirement already satisfied: Flask>=1.0.4 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from flask-login) (3.1.2)\n",
      "Requirement already satisfied: Werkzeug>=1.0.1 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from flask-login) (3.1.3)\n",
      "Requirement already satisfied: greenlet>=1 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from sqlalchemy) (3.2.4)\n",
      "Requirement already satisfied: typing-extensions>=4.6.0 in /home/codespace/.local/lib/python3.12/site-packages (from sqlalchemy) (4.14.1)\n",
      "Requirement already satisfied: blinker>=1.9.0 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from Flask>=1.0.4->flask-login) (1.9.0)\n",
      "Requirement already satisfied: click>=8.1.3 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from Flask>=1.0.4->flask-login) (8.3.0)\n",
      "Requirement already satisfied: itsdangerous>=2.2.0 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from Flask>=1.0.4->flask-login) (2.2.0)\n",
      "Requirement already satisfied: jinja2>=3.1.2 in /home/codespace/.local/lib/python3.12/site-packages (from Flask>=1.0.4->flask-login) (3.1.6)\n",
      "Requirement already satisfied: markupsafe>=2.1.1 in /home/codespace/.local/lib/python3.12/site-packages (from Flask>=1.0.4->flask-login) (3.0.2)\n",
      "Requirement already satisfied: six>=1.5 in /home/codespace/.local/lib/python3.12/site-packages (from python-dateutil>=2.8.2->pandas) (1.17.0)\n",
      "\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m25.1.1\u001b[0m\u001b[39;49m -> \u001b[0m\u001b[32;49m25.2\u001b[0m\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpython -m pip install --upgrade pip\u001b[0m\n",
      "Note: you may need to restart the kernel to use updated packages.\n"
     ]
    }
   ],
   "source": [
    "%pip install requests pandas plotly flask-login sqlalchemy python-dotenv"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "61035e94",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Import required libraries\n",
    "import os\n",
    "import requests\n",
    "import pandas as pd\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "import json\n",
    "\n",
    "# Load environment variables\n",
    "load_dotenv()\n",
    "\n",
    "# N8N API Configuration\n",
    "N8N_URL = os.getenv('N8N_URL', 'https://dispatch-pipeline.fly.dev')\n",
    "N8N_API_KEY = os.getenv('N8N_API_KEY', '')  # Will be filled through the dashboard"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4d448fcb",
   "metadata": {},
   "source": [
    "## 1. System Status Check\n",
    "\n",
    "This section helps you monitor the health of your n8n instance and check various system components."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "af8d8968",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Component</th>\n",
       "      <th>Status</th>\n",
       "      <th>Message</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>N8N Service</td>\n",
       "      <td>üî¥ Offline</td>\n",
       "      <td>N8N returned status code: 503</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Database</td>\n",
       "      <td>üî¥ Disconnected</td>\n",
       "      <td>Database connection failed</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "     Component          Status                        Message\n",
       "0  N8N Service       üî¥ Offline  N8N returned status code: 503\n",
       "1     Database  üî¥ Disconnected     Database connection failed"
      ]
     },
     "execution_count": 10,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "def check_n8n_status():\n",
    "    \"\"\"Check if n8n is accessible and running\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/healthz\")\n",
    "        if response.status_code == 200:\n",
    "            return True, \"N8N is running normally\"\n",
    "        return False, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database():\n",
    "    \"\"\"Check database connection\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/executions\",\n",
    "                              headers={'X-N8N-API-KEY': N8N_API_KEY})\n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working\"\n",
    "        return False, \"Database connection failed\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "def check_concurrency():\n",
    "    \"\"\"Check current workflow concurrency and warn if approaching SQLite limits\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/executions?status=running&limit=100\",\n",
    "                              headers={'X-N8N-API-KEY': N8N_API_KEY})\n",
    "        if response.status_code == 200:\n",
    "            executions = response.json()\n",
    "            running_count = len(executions)\n",
    "\n",
    "            # SQLite concurrency warning thresholds\n",
    "            if running_count >= 8:\n",
    "                status = \"üö® CRITICAL\"\n",
    "                message = f\"{running_count} concurrent workflows - APPROACHING SQLITE LIMIT!\"\n",
    "            elif running_count >= 5:\n",
    "                status = \"‚ö†Ô∏è WARNING\"\n",
    "                message = f\"{running_count} concurrent workflows - Monitor closely\"\n",
    "            else:\n",
    "                status = \"‚úÖ NORMAL\"\n",
    "                message = f\"{running_count} concurrent workflows - Safe range\"\n",
    "\n",
    "            return running_count, status, message\n",
    "        return 0, \"‚ùå ERROR\", \"Failed to fetch execution data\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return 0, \"‚ùå ERROR\", f\"Connection failed: {str(e)}\"\n",
    "\n",
    "def display_system_status():\n",
    "    \"\"\"Display system status in a formatted way\"\"\"\n",
    "    n8n_status, n8n_msg = check_n8n_status()\n",
    "    db_status, db_msg = check_database()\n",
    "    concurrency_count, concurrency_status, concurrency_msg = check_concurrency()\n",
    "\n",
    "    status_df = pd.DataFrame({\n",
    "        'Component': ['N8N Service', 'Database', 'Concurrency'],\n",
    "        'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "                  'üü¢ Connected' if db_status else 'üî¥ Disconnected',\n",
    "                  concurrency_status],\n",
    "        'Message': [n8n_msg, db_msg, f\"{concurrency_count} running workflows - {concurrency_msg}\"]\n",
    "    })\n",
    "\n",
    "    return status_df\n",
    "\n",
    "# Display current system status\n",
    "display_system_status()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "78004ef2",
   "metadata": {},
   "source": [
    "## 2. Configuration Management\n",
    "\n",
    "This section allows you to view and update n8n configuration settings."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a44c8a95",
   "metadata": {},
   "source": [
    "## 3. Concurrency Watchdog ‚ö°\n",
    "\n",
    "**Critical Monitoring:** Tracks concurrent workflow executions to trigger PostgreSQL migration planning.\n",
    "\n",
    "**Operational Mandate:**\n",
    "- **üü° YELLOW (5-7 concurrent):** Migration plan activated. Schedule downtime within 7 days.\n",
    "- **üî¥ RED (8+ concurrent):** CRITICAL - Execute immediate migration to `n8n-db-pristine` cluster.\n",
    "\n",
    "**SQLite Limits:** Maximum 10-15 concurrent writers before SQLITE_BUSY errors occur."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4cbba1cf",
   "metadata": {},
   "outputs": [],
   "source": [
    "def display_concurrency_monitor():\n",
    "    \"\"\"Display detailed concurrency monitoring with warnings\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/executions?status=running&limit=100\",\n",
    "                              headers={'X-N8N-API-KEY': N8N_API_KEY})\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            executions = response.json()\n",
    "            running_count = len(executions)\n",
    "\n",
    "            # Create monitoring display with migration triggers\n",
    "            if running_count >= 8:\n",
    "                alert_color = \"#dc3545\"  # Red\n",
    "                alert_icon = \"üö®\"\n",
    "                alert_title = \"CRITICAL: EXECUTE POSTGRESQL MIGRATION\"\n",
    "                action_required = \"üî¥ RED CONDITION: Halt new workflows and begin immediate migration to n8n-db-pristine cluster\"\n",
    "            elif running_count >= 5:\n",
    "                alert_color = \"#ffc107\"  # Yellow\n",
    "                alert_icon = \"‚ö†Ô∏è\"\n",
    "                alert_title = \"WARNING: SCHEDULE POSTGRESQL MIGRATION\"\n",
    "                action_required = \"üü° YELLOW CONDITION: Migration plan activated. Schedule downtime within 7 days.\"\n",
    "            else:\n",
    "                alert_color = \"#28a745\"  # Green\n",
    "                alert_icon = \"‚úÖ\"\n",
    "                alert_title = \"NORMAL: Safe Concurrency\"\n",
    "                action_required = \"Monitor concurrency levels\"\n",
    "\n",
    "            html_output = f\"\"\"\n",
    "            <div style=\"background: {alert_color}; color: white; padding: 15px; border-radius: 8px; margin: 10px 0;\">\n",
    "                <h4 style=\"margin-top: 0;\">{alert_icon} {alert_title}</h4>\n",
    "                <p><strong>Current Concurrent Workflows:</strong> {running_count}</p>\n",
    "                <p><strong>SQLite Write Limit:</strong> 10-15 concurrent operations</p>\n",
    "                <p><strong>Action Required:</strong> {action_required}</p>\n",
    "                {'<p style=\"color: yellow; font-weight: bold;\">üö® CRITICAL: EXECUTE IMMEDIATE MIGRATION TO POSTGRESQL</p>' if running_count >= 8 else '<p style=\"color: black; font-weight: bold;\">‚ö†Ô∏è SCHEDULE MIGRATION WITHIN 7 DAYS</p>' if running_count >= 5 else '<p style=\"color: white;\">‚úÖ System operating within safe limits</p>'}\n",
    "            </div>\n",
    "            \"\"\"\n",
    "\n",
    "            display(HTML(html_output))\n",
    "\n",
    "            # Show running workflows if any\n",
    "            if running_count > 0:\n",
    "                workflow_names = [exec.get('workflowName', 'Unknown') for exec in executions[:10]]  # Show first 10\n",
    "                print(f\"\\nüìã Currently Running Workflows ({running_count} total):\")\n",
    "                for i, name in enumerate(workflow_names, 1):\n",
    "                    print(f\"  {i}. {name}\")\n",
    "                if running_count > 10:\n",
    "                    print(f\"  ... and {running_count - 10} more\")\n",
    "            else:\n",
    "                print(\"\\nüìã No workflows currently running\")\n",
    "\n",
    "        else:\n",
    "            display(HTML('<div style=\"background: #dc3545; color: white; padding: 15px; border-radius: 8px; margin: 10px 0;\"><h4>‚ùå Monitoring Error</h4><p>Failed to fetch concurrency data</p></div>'))\n",
    "\n",
    "    except Exception as e:\n",
    "        display(HTML(f'<div style=\"background: #dc3545; color: white; padding: 15px; border-radius: 8px; margin: 10px 0;\"><h4>‚ùå Connection Error</h4><p>{str(e)}</p></div>'))\n",
    "\n",
    "# Display concurrency monitor\n",
    "display_concurrency_monitor()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "438b413b",
   "metadata": {},
   "source": [
    "## 4. System Metrics\n",
    "\n",
    "View system performance metrics and execution statistics."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3ed99f75",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "No execution data available\n"
     ]
    }
   ],
   "source": [
    "def get_execution_metrics():\n",
    "    \"\"\"Fetch and analyze workflow execution metrics\"\"\"\n",
    "    try:\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/executions\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY},\n",
    "            params={'limit': 100}  # Last 100 executions\n",
    "        )\n",
    "        if response.status_code != 200:\n",
    "            return pd.DataFrame()\n",
    "        \n",
    "        executions = response.json()\n",
    "        execution_data = []\n",
    "        \n",
    "        for exec in executions:\n",
    "            execution_data.append({\n",
    "                'Workflow': exec.get('workflowName'),\n",
    "                'Status': exec.get('status'),\n",
    "                'Duration': exec.get('duration', 0),\n",
    "                'Timestamp': datetime.fromisoformat(exec.get('startedAt')).strftime('%Y-%m-%d %H:%M')\n",
    "            })\n",
    "        \n",
    "        return pd.DataFrame(execution_data)\n",
    "    except:\n",
    "        return pd.DataFrame()\n",
    "\n",
    "def plot_execution_metrics():\n",
    "    \"\"\"Create visualizations for execution metrics\"\"\"\n",
    "    df = get_execution_metrics()\n",
    "    if df.empty:\n",
    "        print(\"No execution data available\")\n",
    "        return\n",
    "    \n",
    "    # Success rate by workflow\n",
    "    fig1 = px.pie(\n",
    "        df.groupby('Workflow')['Status'].apply(lambda x: (x == 'success').mean()),\n",
    "        values=0,\n",
    "        names=df['Workflow'].unique(),\n",
    "        title='Workflow Success Rate'\n",
    "    )\n",
    "    \n",
    "    # Average duration by workflow\n",
    "    fig2 = px.bar(\n",
    "        df.groupby('Workflow')['Duration'].mean().reset_index(),\n",
    "        x='Workflow',\n",
    "        y='Duration',\n",
    "        title='Average Execution Duration by Workflow'\n",
    "    )\n",
    "    \n",
    "    fig1.show()\n",
    "    fig2.show()\n",
    "\n",
    "# Display metrics\n",
    "plot_execution_metrics()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "41ea3cd4",
   "metadata": {},
   "source": [
    "## 5. Testing Tools\n",
    "\n",
    "Test your n8n workflows and endpoints."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "eae8d30c",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "1709642eef0f441f91f57d029c7927ff",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Text(value='', description='Webhook URL:', layout=Layout(width='50%'), style=TextStyle(description_width='init‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "497888caaf614f8a90c94bdaee8d2494",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Textarea(value='{}', description='Payload (JSON):', layout=Layout(width='50%'), style=TextStyle(description_wi‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "c428f8df9c58481d88adf7eea220b021",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Button(button_style='primary', description='Test Webhook', style=ButtonStyle())"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def test_webhook(webhook_url, payload=None):\n",
    "    \"\"\"Test a webhook endpoint\"\"\"\n",
    "    try:\n",
    "        payload = payload or {\"test\": True, \"timestamp\": datetime.now().isoformat()}\n",
    "        response = requests.post(webhook_url, json=payload)\n",
    "        return {\n",
    "            'Status Code': response.status_code,\n",
    "            'Response': response.text,\n",
    "            'Headers': dict(response.headers)\n",
    "        }\n",
    "    except Exception as e:\n",
    "        return {'Error': str(e)}\n",
    "\n",
    "# Create webhook testing interface\n",
    "webhook_url_input = widgets.Text(\n",
    "    description='Webhook URL:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "payload_input = widgets.Textarea(\n",
    "    description='Payload (JSON):',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'},\n",
    "    value='{}'\n",
    ")\n",
    "\n",
    "def test_webhook_button_clicked(button):\n",
    "    try:\n",
    "        payload = json.loads(payload_input.value)\n",
    "    except:\n",
    "        print(\"‚ùå Invalid JSON payload\")\n",
    "        return\n",
    "    \n",
    "    clear_output(wait=True)\n",
    "    print(\"üîÑ Testing webhook...\")\n",
    "    result = test_webhook(webhook_url_input.value, payload)\n",
    "    print(\"\\nResults:\")\n",
    "    print(json.dumps(result, indent=2))\n",
    "\n",
    "test_button = widgets.Button(\n",
    "    description='Test Webhook',\n",
    "    button_style='primary'\n",
    ")\n",
    "test_button.on_click(test_webhook_button_clicked)\n",
    "\n",
    "# Display testing interface\n",
    "display(webhook_url_input)\n",
    "display(payload_input)\n",
    "display(test_button)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "456fd6fe",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>ID</th>\n",
       "      <th>Name</th>\n",
       "      <th>Status</th>\n",
       "      <th>Last Updated</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "Empty DataFrame\n",
       "Columns: [ID, Name, Status, Last Updated]\n",
       "Index: []"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "def get_workflows():\n",
    "    \"\"\"Fetch all workflows from n8n\"\"\"\n",
    "    try:\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/workflows\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY}\n",
    "        )\n",
    "        return response.json() if response.status_code == 200 else []\n",
    "    except:\n",
    "        return []\n",
    "\n",
    "def display_workflows():\n",
    "    \"\"\"Display workflows in a formatted table\"\"\"\n",
    "    workflows = get_workflows()\n",
    "    if not workflows:\n",
    "        return pd.DataFrame(columns=['ID', 'Name', 'Status', 'Last Updated'])\n",
    "    \n",
    "    workflow_data = []\n",
    "    for wf in workflows:\n",
    "        workflow_data.append({\n",
    "            'ID': wf.get('id'),\n",
    "            'Name': wf.get('name'),\n",
    "            'Status': 'üü¢ Active' if wf.get('active') else '‚ö´ Inactive',\n",
    "            'Last Updated': datetime.fromisoformat(wf.get('updatedAt')).strftime('%Y-%m-%d %H:%M')\n",
    "        })\n",
    "    \n",
    "    return pd.DataFrame(workflow_data)\n",
    "\n",
    "# Display workflows\n",
    "display_workflows()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "48d64d3f",
   "metadata": {},
   "source": [
    "## 3. Workflow Management\n",
    "\n",
    "Monitor and manage your n8n workflows."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4abbf770",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "87738bdf71454785ba00e1167c88694f",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Text(value='https://n8n-dispatch.fly.dev', description='N8N URL:', style=TextStyle(description_width='initial'‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "2e6cee0cfe6f441db851e15286f93a19",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Password(description='API Key:', style=TextStyle(description_width='initial'))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "7023221131b94b72a18e9c719d0233a7",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Button(button_style='primary', description='Update Configuration', style=ButtonStyle())"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output\n",
    "\n",
    "# Create input widgets for configuration\n",
    "n8n_url_input = widgets.Text(\n",
    "    value=N8N_URL,\n",
    "    description='N8N URL:',\n",
    "    style={'description_width': 'initial'}\n",
    ")\n",
    "\n",
    "api_key_input = widgets.Password(\n",
    "    value=N8N_API_KEY,\n",
    "    description='API Key:',\n",
    "    style={'description_width': 'initial'}\n",
    ")\n",
    "\n",
    "def update_config(button):\n",
    "    global N8N_URL, N8N_API_KEY\n",
    "    N8N_URL = n8n_url_input.value\n",
    "    N8N_API_KEY = api_key_input.value\n",
    "    clear_output()\n",
    "    print(\"‚úÖ Configuration updated successfully!\")\n",
    "    display_system_status()\n",
    "\n",
    "update_button = widgets.Button(\n",
    "    description='Update Configuration',\n",
    "    button_style='primary'\n",
    ")\n",
    "update_button.on_click(update_config)\n",
    "\n",
    "# Display configuration widgets\n",
    "display(n8n_url_input)\n",
    "display(api_key_input)\n",
    "display(update_button)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "041d9b79",
   "metadata": {},
   "source": [
    "## 2. System Health Check\n",
    "\n",
    "Monitor system resources and container health:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "561f075e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "3f9359f0e162404aa42388b9033d0a0c",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Text(value='https://dispatch-pipeline.fly.dev', description='N8N URL:', layout=Layout(width='50%'), style=Text‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "1a98dd25d0c0451492a7a79f18f9249a",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Text(value='admin', description='Username:', layout=Layout(width='50%'), style=TextStyle(description_width='in‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "43e649ede2294296b631f710fdf0d9ae",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Password(description='Password:', layout=Layout(width='50%'), style=TextStyle(description_width='initial'))"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "d57d67c93f5a4cdf94313e1f87195401",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Button(button_style='info', description='Test Connection', style=ButtonStyle())"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "f1b0d59054994de09340714640054ea0",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "Output()"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Create authentication widgets\n",
    "n8n_url = widgets.Text(\n",
    "    value='https://dispatch-pipeline.fly.dev',\n",
    "    description='N8N URL:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "username = widgets.Text(\n",
    "    value='admin',\n",
    "    description='Username:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "password = widgets.Password(\n",
    "    description='Password:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "test_auth_button = widgets.Button(\n",
    "    description='Test Connection',\n",
    "    button_style='info'\n",
    ")\n",
    "\n",
    "auth_output = widgets.Output()\n",
    "\n",
    "def test_auth(b):\n",
    "    with auth_output:\n",
    "        clear_output()\n",
    "        try:\n",
    "            response = requests.get(\n",
    "                f\"{n8n_url.value}/healthz\",\n",
    "                auth=(username.value, password.value),\n",
    "                timeout=5\n",
    "            )\n",
    "            if response.status_code == 200:\n",
    "                print(\"‚úÖ Connection successful!\")\n",
    "            else:\n",
    "                print(f\"‚ùå Connection failed! Status code: {response.status_code}\")\n",
    "        except Exception as e:\n",
    "            print(f\"‚ùå Error connecting to n8n: {str(e)}\")\n",
    "\n",
    "test_auth_button.on_click(test_auth)\n",
    "\n",
    "# Display widgets\n",
    "display(n8n_url, username, password, test_auth_button, auth_output)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "61823e09",
   "metadata": {},
   "source": [
    "## 1. Authentication and Connection Settings\n",
    "\n",
    "Enter your n8n credentials and connection details:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6fde50d3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Import required libraries\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output\n",
    "import requests\n",
    "import json\n",
    "import psutil\n",
    "import pandas as pd\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from datetime import datetime\n",
    "import os\n",
    "import re"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6b5494bd",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Requirement already satisfied: ipywidgets in /home/codespace/.local/lib/python3.12/site-packages (8.1.7)\n",
      "Requirement already satisfied: requests in /home/codespace/.local/lib/python3.12/site-packages (2.32.5)\n",
      "Requirement already satisfied: psutil in /home/codespace/.local/lib/python3.12/site-packages (7.0.0)\n",
      "Requirement already satisfied: pandas in /home/codespace/.local/lib/python3.12/site-packages (2.3.3)\n",
      "Requirement already satisfied: plotly in /home/codespace/.local/lib/python3.12/site-packages (6.3.1)\n",
      "Requirement already satisfied: pymongo in /usr/local/python/3.12.1/lib/python3.12/site-packages (4.15.3)\n",
      "Requirement already satisfied: comm>=0.1.3 in /home/codespace/.local/lib/python3.12/site-packages (from ipywidgets) (0.2.2)\n",
      "Requirement already satisfied: ipython>=6.1.0 in /home/codespace/.local/lib/python3.12/site-packages (from ipywidgets) (9.4.0)\n",
      "Requirement already satisfied: traitlets>=4.3.1 in /home/codespace/.local/lib/python3.12/site-packages (from ipywidgets) (5.14.3)\n",
      "Requirement already satisfied: widgetsnbextension~=4.0.14 in /home/codespace/.local/lib/python3.12/site-packages (from ipywidgets) (4.0.14)\n",
      "Requirement already satisfied: jupyterlab_widgets~=3.0.15 in /home/codespace/.local/lib/python3.12/site-packages (from ipywidgets) (3.0.15)\n",
      "Requirement already satisfied: charset_normalizer<4,>=2 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (3.4.2)\n",
      "Requirement already satisfied: idna<4,>=2.5 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (3.10)\n",
      "Requirement already satisfied: urllib3<3,>=1.21.1 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (2.5.0)\n",
      "Requirement already satisfied: certifi>=2017.4.17 in /home/codespace/.local/lib/python3.12/site-packages (from requests) (2025.7.9)\n",
      "Requirement already satisfied: numpy>=1.26.0 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2.3.1)\n",
      "Requirement already satisfied: python-dateutil>=2.8.2 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2.9.0.post0)\n",
      "Requirement already satisfied: pytz>=2020.1 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2025.2)\n",
      "Requirement already satisfied: tzdata>=2022.7 in /home/codespace/.local/lib/python3.12/site-packages (from pandas) (2025.2)\n",
      "Requirement already satisfied: narwhals>=1.15.1 in /home/codespace/.local/lib/python3.12/site-packages (from plotly) (1.46.0)\n",
      "Requirement already satisfied: packaging in /home/codespace/.local/lib/python3.12/site-packages (from plotly) (25.0)\n",
      "Requirement already satisfied: dnspython<3.0.0,>=1.16.0 in /usr/local/python/3.12.1/lib/python3.12/site-packages (from pymongo) (2.8.0)\n",
      "Requirement already satisfied: decorator in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (5.2.1)\n",
      "Requirement already satisfied: ipython-pygments-lexers in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (1.1.1)\n",
      "Requirement already satisfied: jedi>=0.16 in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (0.19.2)\n",
      "Requirement already satisfied: matplotlib-inline in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (0.1.7)\n",
      "Requirement already satisfied: pexpect>4.3 in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (4.9.0)\n",
      "Requirement already satisfied: prompt_toolkit<3.1.0,>=3.0.41 in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (3.0.51)\n",
      "Requirement already satisfied: pygments>=2.4.0 in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (2.19.2)\n",
      "Requirement already satisfied: stack_data in /home/codespace/.local/lib/python3.12/site-packages (from ipython>=6.1.0->ipywidgets) (0.6.3)\n",
      "Requirement already satisfied: wcwidth in /home/codespace/.local/lib/python3.12/site-packages (from prompt_toolkit<3.1.0,>=3.0.41->ipython>=6.1.0->ipywidgets) (0.2.13)\n",
      "Requirement already satisfied: parso<0.9.0,>=0.8.4 in /home/codespace/.local/lib/python3.12/site-packages (from jedi>=0.16->ipython>=6.1.0->ipywidgets) (0.8.4)\n",
      "Requirement already satisfied: ptyprocess>=0.5 in /home/codespace/.local/lib/python3.12/site-packages (from pexpect>4.3->ipython>=6.1.0->ipywidgets) (0.7.0)\n",
      "Requirement already satisfied: six>=1.5 in /home/codespace/.local/lib/python3.12/site-packages (from python-dateutil>=2.8.2->pandas) (1.17.0)\n",
      "Requirement already satisfied: executing>=1.2.0 in /home/codespace/.local/lib/python3.12/site-packages (from stack_data->ipython>=6.1.0->ipywidgets) (2.2.0)\n",
      "Requirement already satisfied: asttokens>=2.1.0 in /home/codespace/.local/lib/python3.12/site-packages (from stack_data->ipython>=6.1.0->ipywidgets) (3.0.0)\n",
      "Requirement already satisfied: pure-eval in /home/codespace/.local/lib/python3.12/site-packages (from stack_data->ipython>=6.1.0->ipywidgets) (0.2.3)\n",
      "\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m25.1.1\u001b[0m\u001b[39;49m -> \u001b[0m\u001b[32;49m25.2\u001b[0m\n",
      "\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpython -m pip install --upgrade pip\u001b[0m\n",
      "Note: you may need to restart the kernel to use updated packages.\n"
     ]
    }
   ],
   "source": [
    "# Install required packages\n",
    "%pip install ipywidgets requests psutil pandas plotly pymongo"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5e67ef2b",
   "metadata": {},
   "source": [
    "# N8N Admin Dashboard\n",
    "\n",
    "This notebook provides a comprehensive admin dashboard for monitoring and managing your n8n deployment. Use the sections below to:\n",
    "- Check system health\n",
    "- Validate credentials and connections\n",
    "- Monitor API endpoints\n",
    "- Analyze logs\n",
    "- Track user activity\n",
    "\n",
    "First, let's install the required packages:"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c499b85a",
   "metadata": {},
   "source": [
    "## Workflow Control Panel\n",
    "\n",
    "This section provides direct control over N8N workflows:\n",
    "- Lists all active workflows\n",
    "- Allows selection of specific workflows\n",
    "- Enables immediate activation/deactivation of workflows\n",
    "- Shows current status of selected workflow\n",
    "\n",
    "‚ö†Ô∏è **Important**: Use these controls with caution as they directly affect production workflows."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "99919e0b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Error fetching workflows: No connection adapters were found for \"Text(value='https://dispatch-pipeline.fly.dev', description='N8N URL:', layout=Layout(width='50%'), style=TextStyle(description_width='initial'))/api/v1/workflows\"\n"
     ]
    },
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "e1fed737f1254ca5993065ce6b61b03e",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "VBox(children=(HBox(children=(Dropdown(description='Workflow:', layout=Layout(width='50%'), options=(), style=‚Ä¶"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def get_all_workflows():\n",
    "    \"\"\"Fetch all workflows from N8N API\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{n8n_url}/api/v1/workflows\", headers=headers)\n",
    "        response.raise_for_status()\n",
    "        return response.json()\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        print(f\"Error fetching workflows: {str(e)}\")\n",
    "        return []\n",
    "\n",
    "def update_workflow_status(workflow_id, active):\n",
    "    \"\"\"Update the active status of a workflow\"\"\"\n",
    "    try:\n",
    "        endpoint = f\"{n8n_url}/api/v1/workflows/{workflow_id}/activate\" if active else f\"{n8n_url}/api/v1/workflows/{workflow_id}/deactivate\"\n",
    "        response = requests.post(endpoint, headers=headers)\n",
    "        response.raise_for_status()\n",
    "        return True\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        print(f\"Error updating workflow status: {str(e)}\")\n",
    "        return False\n",
    "\n",
    "# Create widgets for workflow control\n",
    "workflow_dropdown = widgets.Dropdown(\n",
    "    description='Workflow:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout=widgets.Layout(width='50%')\n",
    ")\n",
    "\n",
    "status_label = widgets.HTML(\n",
    "    value='<span style=\"color: gray;\">No workflow selected</span>'\n",
    ")\n",
    "\n",
    "toggle_button = widgets.ToggleButton(\n",
    "    value=False,\n",
    "    description='Inactive',\n",
    "    button_style='danger',\n",
    "    tooltip='Toggle workflow active status',\n",
    "    icon='power-off',\n",
    "    layout=widgets.Layout(width='150px')\n",
    ")\n",
    "\n",
    "def update_workflow_list(*_):\n",
    "    \"\"\"Update the workflow dropdown with current workflows\"\"\"\n",
    "    workflows = get_all_workflows()\n",
    "    workflow_dropdown.options = [(f\"{w['name']} (ID: {w['id']})\", w['id']) for w in workflows]\n",
    "    workflow_dropdown.value = None\n",
    "    toggle_button.value = False\n",
    "    status_label.value = '<span style=\"color: gray;\">No workflow selected</span>'\n",
    "\n",
    "def on_workflow_select(change):\n",
    "    \"\"\"Handle workflow selection\"\"\"\n",
    "    if change['new'] is None:\n",
    "        toggle_button.value = False\n",
    "        status_label.value = '<span style=\"color: gray;\">No workflow selected</span>'\n",
    "        return\n",
    "    \n",
    "    workflows = get_all_workflows()\n",
    "    selected = next((w for w in workflows if w['id'] == change['new']), None)\n",
    "    if selected:\n",
    "        toggle_button.value = selected.get('active', False)\n",
    "        toggle_button.description = 'Active' if toggle_button.value else 'Inactive'\n",
    "        toggle_button.button_style = 'success' if toggle_button.value else 'danger'\n",
    "        status = 'active' if toggle_button.value else 'inactive'\n",
    "        status_label.value = f'<span style=\"color: {\"green\" if toggle_button.value else \"red\"}\">Status: {status}</span>'\n",
    "\n",
    "def on_toggle(change):\n",
    "    \"\"\"Handle workflow activation/deactivation\"\"\"\n",
    "    if workflow_dropdown.value is None:\n",
    "        return\n",
    "    \n",
    "    success = update_workflow_status(workflow_dropdown.value, change['new'])\n",
    "    if success:\n",
    "        toggle_button.description = 'Active' if change['new'] else 'Inactive'\n",
    "        toggle_button.button_style = 'success' if change['new'] else 'danger'\n",
    "        status = 'active' if change['new'] else 'inactive'\n",
    "        status_label.value = f'<span style=\"color: {\"green\" if change[\"new\"] else \"red\"}\">Status: {status}</span>'\n",
    "    else:\n",
    "        # Revert the toggle if update failed\n",
    "        toggle_button.value = not change['new']\n",
    "\n",
    "# Wire up the event handlers\n",
    "workflow_dropdown.observe(on_workflow_select, names='value')\n",
    "toggle_button.observe(on_toggle, names='value')\n",
    "\n",
    "# Create refresh button\n",
    "refresh_button = widgets.Button(\n",
    "    description='Refresh List',\n",
    "    icon='sync',\n",
    "    tooltip='Refresh workflow list',\n",
    "    layout=widgets.Layout(width='150px')\n",
    ")\n",
    "refresh_button.on_click(update_workflow_list)\n",
    "\n",
    "# Create the control panel layout\n",
    "controls = widgets.VBox([\n",
    "    widgets.HBox([workflow_dropdown, refresh_button], layout=widgets.Layout(align_items='center')),\n",
    "    widgets.HBox([toggle_button, status_label], layout=widgets.Layout(align_items='center', padding='10px 0'))\n",
    "])\n",
    "\n",
    "# Initial population of workflow list\n",
    "update_workflow_list()\n",
    "\n",
    "# Display the control panel\n",
    "display(controls)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "dbcef3fb",
   "metadata": {},
   "source": [
    "## System Status Verification\n",
    "\n",
    "Execute the following cell to verify the N8N deployment status and API connectivity:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6dac49ca",
   "metadata": {},
   "outputs": [
    {
     "ename": "SyntaxError",
    "    try:\n",
    "        response = requests.get(f\"{url}/healthz\", timeout=5)\n",
    "        return response.status_code == 200, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database(url, api_key):\n",
    "    \"\"\"Check database connection via API key access\"\"\"\n",
    "    if not api_key:\n",
    "        return False, \"API Key is not set.\"\n",
    "    try:\n",
    "        response = requests.get(f\"{url}/api/v1/workflows?limit=1\",\n",
    "                                headers={'X-N8N-API-KEY': api_key}, timeout=5)\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working (Workflows accessible)\"\n",
    "        elif response.status_code == 401:\n",
    "            return False, \"API Key Unauthorized (401)\"\n",
    "        return False, f\"API check failed: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "# --- Execute Verification ---\n",
    "print(\"\\n--- System Status Verification ---\")\n",
    "\n",
    "# Get current configuration from global variables\n",
    "n8n_url = N8N_URL\n",
    "api_key = N8N_API_KEY\n",
    "\n",
    "n8n_status, n8n_msg = check_n8n_status(n8n_url)\n",
    "db_status, db_msg = check_database(n8n_url, api_key)\n",
    "\n",
    "status_df = pd.DataFrame({\n",
    "    'Component': ['N8N Service', 'Persistence (DB)'],\n",
    "    'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "               'üü¢ Connected' if db_status else 'üî¥ Disconnected'],\n",
    "    'Message': [n8n_msg, db_msg]\n",
    "})\n",
    "\n",
    "print(\"\\nStatus Report:\")\n",
    "print(\"=============\")\n",
    "print(status_df.to_markdown(index=False))\n",
    "\n",
    "# Print overall status\n",
    "if n8n_status and db_status:\n",
    "    print(\"\\n‚úÖ All systems operational!\")\n",
    "else:\n",
    "    print(\"\\n‚ùå Some components are not functioning correctly. Please check the status report above.\")\n",
    "\n",
    "---\n",
    "\n",
    "<a id=\"config\"></a>\n",
    "## ‚öôÔ∏è Step 2: Configuration\n",
    "\n",
    "**Status**: üîß Configure your n8n connection\n",
    "\n",
    "### üìù Instructions:\n",
    "1. **N8N URL**: Enter your n8n instance URL (e.g., `https://n8n-dispatch.fly.dev`)\n",
    "2. **API Key**: Create one in n8n Settings ‚Üí API ‚Üí Add API Key\n",
    "3. **Click \"Test Connection\"** to verify everything works\n",
    "4. **Success = Green checkmark** ‚úÖ\n",
    "\n",
    "**üí° Need an API Key?**\n",
    "- Go to your n8n dashboard\n",
    "- Settings ‚Üí API ‚Üí Add API Key\n",
    "- Name it something like \"admin_dashboard\"\n",
    "- Copy the generated key (you won't see it again!)\n",
    "\n",
    "---\n",
    "\n",
    "**üîó Current Configuration:**\n",
    "- URL: `{N8N_URL}`\n",
    "- API Key: `{'‚úÖ Configured' if N8N_API_KEY else '‚ùå Not configured'}`"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1db17175",
   "metadata": {},
   "source": [
    "## System Status Check\n",
    "\n",
    "The following cell implements health checks for the n8n instance and database connection:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "097dbe97",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Component</th>\n",
       "      <th>Status</th>\n",
       "      <th>Message</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>N8N Service</td>\n",
       "      <td>üü¢ Online</td>\n",
       "      <td>N8N is running normally</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Persistence (DB)</td>\n",
       "      <td>üî¥ Disconnected</td>\n",
       "      <td>API Key Unauthorized (401) - Check permissions...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          Component          Status  \\\n",
       "0       N8N Service        üü¢ Online   \n",
       "1  Persistence (DB)  üî¥ Disconnected   \n",
       "\n",
       "                                             Message  \n",
       "0                            N8N is running normally  \n",
       "1  API Key Unauthorized (401) - Check permissions...  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Component</th>\n",
       "      <th>Status</th>\n",
       "      <th>Message</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>N8N Service</td>\n",
       "      <td>üü¢ Online</td>\n",
       "      <td>N8N is running normally</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Persistence (DB)</td>\n",
       "      <td>üî¥ Disconnected</td>\n",
       "      <td>API Key Unauthorized (401) - Check permissions...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          Component          Status  \\\n",
       "0       N8N Service        üü¢ Online   \n",
       "1  Persistence (DB)  üî¥ Disconnected   \n",
       "\n",
       "                                             Message  \n",
       "0                            N8N is running normally  \n",
       "1  API Key Unauthorized (401) - Check permissions...  "
      ]
     },
     "execution_count": 20,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "def check_n8n_status():\n",
    "    \"\"\"Check if n8n is accessible and running\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/healthz\", timeout=5)\n",
    "        if response.status_code == 200:\n",
    "            return True, \"N8N is running normally\"\n",
    "        return False, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database():\n",
    "    \"\"\"Check database connection via API key access\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        return False, \"API Key is not set.\"\n",
    "\n",
    "    try:\n",
    "        # Try workflows endpoint first\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/workflows?limit=1\",\n",
    "                                headers={'X-N8N-API-KEY': N8N_API_KEY}, timeout=5)\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working (Workflows accessible)\"\n",
    "        elif response.status_code == 401:\n",
    "            # API key exists but may have limited permissions\n",
    "            # Try executions endpoint as alternative\n",
    "            exec_response = requests.get(f\"{N8N_URL}/api/v1/executions?limit=1\",\n",
    "                                       headers={'X-N8N-API-KEY': N8N_API_KEY}, timeout=5)\n",
    "            if exec_response.status_code == 200:\n",
    "                return True, \"API key valid (Executions accessible, limited workflow permissions)\"\n",
    "            else:\n",
    "                return False, f\"API Key Unauthorized (401) - Check permissions in n8n settings\"\n",
    "        elif response.status_code == 403:\n",
    "            return False, \"API Key Forbidden (403) - Insufficient permissions\"\n",
    "        else:\n",
    "            return False, f\"API check failed: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "def display_system_status():\n",
    "    \"\"\"Display system status in a formatted way\"\"\"\n",
    "    n8n_status, n8n_msg = check_n8n_status()\n",
    "    db_status, db_msg = check_database()\n",
    "    \n",
    "    status_df = pd.DataFrame({\n",
    "        'Component': ['N8N Service', 'Persistence (DB)'],\n",
    "        'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "                   'üü¢ Connected' if db_status else 'üî¥ Disconnected'],\n",
    "        'Message': [n8n_msg, db_msg]\n",
    "    })\n",
    "    \n",
    "    display(status_df)\n",
    "    return status_df\n",
    "\n",
    "# Run initial status check\n",
    "display_system_status()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5c4de8ab",
   "metadata": {},
   "source": [
    "## Configuration Manager\n",
    "\n",
    "Update your n8n configuration settings:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "09645bca",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create input widgets for configuration\n",
    "n8n_url_input = widgets.Text(\n",
    "    value=N8N_URL,\n",
    "    description='N8N URL:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%'}\n",
    ")\n",
    "\n",
    "api_key_input = widgets.Password(\n",
    "    value=N8N_API_KEY,\n",
    "    description='API Key:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%'}\n",
    ")\n",
    "\n",
    "config_output = widgets.Output()\n",
    "\n",
    "def update_config(button):\n",
    "    global N8N_URL, N8N_API_KEY\n",
    "    with config_output:\n",
    "        clear_output(wait=True)\n",
    "        N8N_URL = n8n_url_input.value\n",
    "        N8N_API_KEY = api_key_input.value\n",
    "        print(\"‚úÖ Configuration updated successfully!\")\n",
    "        print(\"\\nVerifying connection...\")\n",
    "        display_system_status()\n",
    "\n",
    "update_button = widgets.Button(\n",
    "    description='Update Configuration',\n",
    "    button_style='primary'\n",
    ")\n",
    "update_button.on_click(update_config)\n",
    "\n",
    "# Display configuration widgets\n",
    "display(widgets.VBox([\n",
    "    n8n_url_input,\n",
    "    api_key_input,\n",
    "    update_button,\n",
    "    config_output\n",
    "]))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "505a9b75",
   "metadata": {},
   "source": [
    "# üóÑÔ∏è Database Management {#database-management}\n",
    "\n",
    "**Status**: ‚úÖ PostgreSQL Migration Ready\n",
    "\n",
    "This section provides tools for managing your database migration from SQLite to PostgreSQL.\n",
    "\n",
    "## PostgreSQL Connection & Validation üõ†Ô∏è\n",
    "\n",
    "### Current Status\n",
    "- **PostgreSQL Cluster**: `n8n-db-pristine` ‚úÖ **HEALTHY** (3/3 instances)\n",
    "- **Migration Trigger**: Monitor concurrency levels (Yellow: 5-7, Red: 8+ concurrent workflows)\n",
    "- **Migration Method**: N8N CLI export/import or custom tooling\n",
    "\n",
    "### Reconnection Commands\n",
    "\n",
    "```bash\n",
    "# Secure connection to PostgreSQL cluster\n",
    "fly postgres connect --app n8n-db-pristine\n",
    "```\n",
    "\n",
    "### Pre-Migration Validation Checks\n",
    "\n",
    "| Command | Purpose |\n",
    "| :--- | :--- |\n",
    "| `\\l` | **List Databases** - Confirms n8n database exists |\n",
    "| `\\c n8n_bulletproof_v2` | **Connect to N8N Database** - Access migration target |\n",
    "| `\\dt` | **List Tables** - Verify schema structure |\n",
    "| `SELECT version();` | **Check Version** - Confirm PostgreSQL compatibility |\n",
    "| `\\q` | **Quit** - Close connection |\n",
    "\n",
    "### Migration Readiness Checklist\n",
    "- ‚úÖ **Cluster Health**: 3/3 instances running\n",
    "- ‚úÖ **Connection**: SSH tunnel established  \n",
    "- ‚úÖ **Credentials**: Stored in Fly.io secrets\n",
    "- ‚úÖ **Monitoring**: Concurrency watchdog active\n",
    "- ‚è≥ **Migration Plan**: Execute when concurrency triggers reached\n",
    "\n",
    "**The PostgreSQL cluster is production-ready for migration when your concurrency monitoring indicates the need.**"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e6f461d8",
   "metadata": {},
   "source": [
    "# üóÑÔ∏è Database Management {#database-management}\n",
    "\n",
    "**Status**: ‚úÖ PostgreSQL Migration Ready\n",
    "\n",
    "This section provides tools for managing your database migration from SQLite to PostgreSQL.\n",
    "\n",
    "## PostgreSQL Connection & Validation üõ†Ô∏è\n",
    "\n",
    "### Current Status\n",
    "- **PostgreSQL Cluster**: `n8n-db-pristine` ‚úÖ **HEALTHY** (3/3 instances)\n",
    "- **Migration Trigger**: Monitor concurrency levels (Yellow: 5-7, Red: 8+ concurrent workflows)\n",
    "- **Migration Method**: N8N CLI export/import or custom tooling\n",
    "\n",
    "### Reconnection Commands\n",
    "\n",
    "```bash\n",
    "# Secure connection to PostgreSQL cluster\n",
    "fly postgres connect --app n8n-db-pristine\n",
    "```\n",
    "\n",
    "### Pre-Migration Validation Checks\n",
    "\n",
    "| Command | Purpose |\n",
    "| :--- | :--- |\n",
    "| `\\l` | **List Databases** - Confirms n8n database exists |\n",
    "| `\\c n8n_bulletproof_v2` | **Connect to N8N Database** - Access migration target |\n",
    "| `\\dt` | **List Tables** - Verify schema structure |\n",
    "| `SELECT version();` | **Check Version** - Confirm PostgreSQL compatibility |\n",
    "| `\\q` | **Quit** - Close connection |\n",
    "\n",
    "### Migration Readiness Checklist\n",
    "- ‚úÖ **Cluster Health**: 3/3 instances running\n",
    "- ‚úÖ **Connection**: SSH tunnel established  \n",
    "- ‚úÖ **Credentials**: Stored in Fly.io secrets\n",
    "- ‚úÖ **Monitoring**: Concurrency watchdog active\n",
    "- ‚è≥ **Migration Plan**: Execute when concurrency triggers reached\n",
    "\n",
    "**The PostgreSQL cluster is production-ready for migration when your concurrency monitoring indicates the need.**"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5bcd625b",
   "metadata": {},
   "source": [
    "## Workflow and Execution Metrics\n",
    "\n",
    "View metrics about your workflows and their execution history:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0e742416",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_execution_metrics():\n",
    "    \"\"\"Fetch and analyze workflow execution metrics\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        print(\"‚ùå API Key required for metrics.\")\n",
    "        return pd.DataFrame()\n",
    "        \n",
    "    try:\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/executions\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY},\n",
    "            params={'limit': 100} \n",
    "        )\n",
    "        if response.status_code != 200:\n",
    "            print(f\"‚ùå Failed to fetch executions: Status {response.status_code}\")\n",
    "            return pd.DataFrame()\n",
    "        \n",
    "        executions = response.json().get('data', [])\n",
    "        execution_data = []\n",
    "        \n",
    "        for exec in executions:\n",
    "            execution_data.append({\n",
    "                'Workflow': exec.get('workflowName', 'N/A'),\n",
    "                'Status': exec.get('status'),\n",
    "                'Duration_s': exec.get('duration', 0) / 1000,  # Convert ms to seconds\n",
    "                'Timestamp': datetime.fromisoformat(exec.get('startedAt').replace('Z', '+00:00')).strftime('%Y-%m-%d %H:%M')\n",
    "            })\n",
    "        \n",
    "        return pd.DataFrame(execution_data)\n",
    "    except Exception as e:\n",
    "        print(f\"‚ùå Error fetching metrics: {str(e)}\")\n",
    "        return pd.DataFrame()\n",
    "\n",
    "def plot_execution_metrics():\n",
    "    \"\"\"Create visualizations for execution metrics\"\"\"\n",
    "    df = get_execution_metrics()\n",
    "    if df.empty:\n",
    "        return\n",
    "    \n",
    "    # Calculate Success/Failure Counts\n",
    "    status_counts = df.groupby('Status').size().reset_index(name='Count')\n",
    "    fig1 = px.pie(\n",
    "        status_counts,\n",
    "        values='Count',\n",
    "        names='Status',\n",
    "        title='Last 100 Executions Status Breakdown',\n",
    "        color_discrete_map={'success':'green', 'failed':'red', 'running':'blue'}\n",
    "    )\n",
    "    \n",
    "    # Average duration by workflow\n",
    "    fig2 = px.bar(\n",
    "        df.groupby('Workflow')['Duration_s'].mean().reset_index(),\n",
    "        x='Workflow',\n",
    "        y='Duration_s',\n",
    "        title='Average Execution Duration (seconds)',\n",
    "        labels={'Duration_s': 'Average Duration (s)'}\n",
    "    )\n",
    "    \n",
    "    fig1.show()\n",
    "    fig2.show()\n",
    "\n",
    "# Display metrics\n",
    "plot_execution_metrics()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "da51e04c",
   "metadata": {},
   "source": [
    "## Webhook Testing Tools\n",
    "\n",
    "Test your webhook endpoints directly from this dashboard:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9d7adefa",
   "metadata": {},
   "outputs": [],
   "source": [
    "def test_webhook(webhook_url, payload=None):\n",
    "    \"\"\"Test a webhook endpoint\"\"\"\n",
    "    try:\n",
    "        payload = payload or {\"test\": True, \"timestamp\": datetime.now().isoformat()}\n",
    "        response = requests.post(webhook_url, json=payload, timeout=10)\n",
    "        return {\n",
    "            'Status Code': response.status_code,\n",
    "            'Response': response.text,\n",
    "            'Headers': dict(response.headers)\n",
    "        }\n",
    "    except Exception as e:\n",
    "        return {'Error': str(e)}\n",
    "\n",
    "webhook_url_input = widgets.Text(\n",
    "    description='Webhook URL:',\n",
    "    placeholder='e.g., https://n8n.app/webhook-test/...',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%'}\n",
    ")\n",
    "\n",
    "payload_input = widgets.Textarea(\n",
    "    description='Payload (JSON):',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%', 'height': '150px'},\n",
    "    value=json.dumps({\"data\": \"test_payload\"}, indent=2) \n",
    ")\n",
    "\n",
    "test_output = widgets.Output()\n",
    "\n",
    "def test_webhook_button_clicked(button):\n",
    "    with test_output:\n",
    "        clear_output(wait=True)\n",
    "        try:\n",
    "            payload = json.loads(payload_input.value)\n",
    "        except:\n",
    "            print(\"‚ùå Invalid JSON payload\")\n",
    "            return\n",
    "        \n",
    "        print(\"üîÑ Testing webhook...\")\n",
    "        result = test_webhook(webhook_url_input.value, payload)\n",
    "        print(\"\\nResults:\")\n",
    "        print(json.dumps(result, indent=2))\n",
    "\n",
    "test_button = widgets.Button(\n",
    "    description='Test Webhook',\n",
    "    button_style='primary'\n",
    ")\n",
    "test_button.on_click(test_webhook_button_clicked)\n",
    "\n",
    "# Display testing interface\n",
    "display(webhook_url_input, payload_input, test_button, test_output)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cd568d13",
   "metadata": {},
   "source": [
    "## Error Logging and Diagnostics\n",
    "\n",
    "Monitor failed executions and system errors:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6409107e",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_failed_executions():\n",
    "    \"\"\"Fetch recent executions and filter for 'failed' status.\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        print(\"‚ùå API Key required for diagnostics.\")\n",
    "        return pd.DataFrame(columns=['ID', 'Workflow', 'Status', 'Started At'])\n",
    "        \n",
    "    try:\n",
    "        # Fetch up to 100 recent executions\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/executions\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY},\n",
    "            params={'limit': 100, 'sort': 'id', 'sortOrder': 'DESC'}\n",
    "        )\n",
    "        response.raise_for_status() # Raise HTTPError for bad responses (4xx or 5xx)\n",
    "        \n",
    "        executions = response.json().get('data', [])\n",
    "        \n",
    "        failed_data = []\n",
    "        for exec in executions:\n",
    "            if exec.get('status') == 'failed':\n",
    "                failed_data.append({\n",
    "                    'ID': exec.get('id'),\n",
    "                    'Workflow': exec.get('workflowName', 'N/A'),\n",
    "                    'Status': 'üî¥ FAILED',\n",
    "                    'Started At': datetime.fromisoformat(exec.get('startedAt').replace('Z', '+00:00')).strftime('%Y-%m-%d %H:%M:%S'),\n",
    "                    'Error Message': exec.get('error', {}).get('message', 'No error message available')\n",
    "                })\n",
    "        \n",
    "        df = pd.DataFrame(failed_data)\n",
    "        if df.empty:\n",
    "            print(\"‚úÖ No failed executions found in the last 100 runs.\")\n",
    "            return pd.DataFrame()\n",
    "        \n",
    "        return df[['ID', 'Workflow', 'Status', 'Started At', 'Error Message']]\n",
    "        \n",
    "    except requests.exceptions.RequestException as e:\n",
    "        print(f\"‚ùå Connection Error: {str(e)}\")\n",
    "    except Exception as e:\n",
    "        print(f\"‚ùå Diagnostic Error: {str(e)}\")\n",
    "        \n",
    "    return pd.DataFrame()\n",
    "\n",
    "# Create an output widget for failed executions\n",
    "failed_executions_output = widgets.Output()\n",
    "\n",
    "def refresh_failed_executions(button=None):\n",
    "    with failed_executions_output:\n",
    "        clear_output(wait=True)\n",
    "        print(\"üîÑ Fetching failed executions...\")\n",
    "        df = get_failed_executions()\n",
    "        if not df.empty:\n",
    "            display(df)\n",
    "\n",
    "refresh_button = widgets.Button(\n",
    "    description='Refresh Failed Executions',\n",
    "    button_style='warning'\n",
    ")\n",
    "refresh_button.on_click(refresh_failed_executions)\n",
    "\n",
    "# Display the refresh button and output area\n",
    "display(refresh_button)\n",
    "display(failed_executions_output)\n",
    "\n",
    "# Initial load of failed executions\n",
    "refresh_failed_executions()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3390f06a",
   "metadata": {},
   "source": [
    "# N8N Admin Dashboard\n",
    "\n",
    "This dashboard provides comprehensive monitoring and management capabilities for your n8n instance. It includes:\n",
    "\n",
    "1. System Status Monitoring\n",
    "2. Configuration Management\n",
    "3. API Testing\n",
    "4. User Management\n",
    "5. Workflow Status\n",
    "\n",
    "## Setup and Requirements\n",
    "\n",
    "First, let's install the required packages:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "684518c6",
   "metadata": {},
   "outputs": [],
   "source": [
    "%pip install requests pandas plotly flask-login sqlalchemy python-dotenv"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0c8bd659",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Import required libraries\n",
    "import os\n",
    "import requests\n",
    "import pandas as pd\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "import json\n",
    "\n",
    "# Load environment variables\n",
    "load_dotenv()\n",
    "\n",
    "# N8N API Configuration\n",
    "N8N_URL = os.getenv('N8N_URL', 'https://dispatch-pipeline.fly.dev')\n",
    "N8N_API_KEY = os.getenv('N8N_API_KEY', '')  # Will be filled through the dashboard"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d9eab2b1",
   "metadata": {},
   "source": [
    "## 1. System Status Check\n",
    "\n",
    "This section helps you monitor the health of your n8n instance and check various system components."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d3a60e81",
   "metadata": {},
   "outputs": [],
   "source": [
    "def check_n8n_status():\n",
    "    \"\"\"Check if n8n is accessible and running\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/healthz\")\n",
    "        if response.status_code == 200:\n",
    "            return True, \"N8N is running normally\"\n",
    "        return False, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database():\n",
    "    \"\"\"Check database connection\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/executions\", \n",
    "                              headers={'X-N8N-API-KEY': N8N_API_KEY})\n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working\"\n",
    "        return False, \"Database connection failed\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "def display_system_status():\n",
    "    \"\"\"Display system status in a formatted way\"\"\"\n",
    "    n8n_status, n8n_msg = check_n8n_status()\n",
    "    db_status, db_msg = check_database()\n",
    "    \n",
    "    status_df = pd.DataFrame({\n",
    "        'Component': ['N8N Service', 'Database'],\n",
    "        'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "                  'üü¢ Connected' if db_status else 'üî¥ Disconnected'],\n",
    "        'Message': [n8n_msg, db_msg]\n",
    "    })\n",
    "    \n",
    "    return status_df\n",
    "\n",
    "# Display current system status\n",
    "display_system_status()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e007b52c",
   "metadata": {},
   "source": [
    "## 2. Configuration Management\n",
    "\n",
    "This section allows you to view and update n8n configuration settings."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1bea4332",
   "metadata": {},
   "source": [
    "## 4. System Metrics\n",
    "\n",
    "View system performance metrics and execution statistics."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fbf5b27a",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_execution_metrics():\n",
    "    \"\"\"Fetch and analyze workflow execution metrics\"\"\"\n",
    "    try:\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/executions\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY},\n",
    "            params={'limit': 100}  # Last 100 executions\n",
    "        )\n",
    "        if response.status_code != 200:\n",
    "            return pd.DataFrame()\n",
    "        \n",
    "        executions = response.json()\n",
    "        execution_data = []\n",
    "        \n",
    "        for exec in executions:\n",
    "            execution_data.append({\n",
    "                'Workflow': exec.get('workflowName'),\n",
    "                'Status': exec.get('status'),\n",
    "                'Duration': exec.get('duration', 0),\n",
    "                'Timestamp': datetime.fromisoformat(exec.get('startedAt')).strftime('%Y-%m-%d %H:%M')\n",
    "            })\n",
    "        \n",
    "        return pd.DataFrame(execution_data)\n",
    "    except:\n",
    "        return pd.DataFrame()\n",
    "\n",
    "def plot_execution_metrics():\n",
    "    \"\"\"Create visualizations for execution metrics\"\"\"\n",
    "    df = get_execution_metrics()\n",
    "    if df.empty:\n",
    "        print(\"No execution data available\")\n",
    "        return\n",
    "    \n",
    "    # Success rate by workflow\n",
    "    fig1 = px.pie(\n",
    "        df.groupby('Workflow')['Status'].apply(lambda x: (x == 'success').mean()),\n",
    "        values=0,\n",
    "        names=df['Workflow'].unique(),\n",
    "        title='Workflow Success Rate'\n",
    "    )\n",
    "    \n",
    "    # Average duration by workflow\n",
    "    fig2 = px.bar(\n",
    "        df.groupby('Workflow')['Duration'].mean().reset_index(),\n",
    "        x='Workflow',\n",
    "        y='Duration',\n",
    "        title='Average Execution Duration by Workflow'\n",
    "    )\n",
    "    \n",
    "    fig1.show()\n",
    "    fig2.show()\n",
    "\n",
    "# Display metrics\n",
    "plot_execution_metrics()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ce639bed",
   "metadata": {},
   "source": [
    "## 5. Testing Tools\n",
    "\n",
    "Test your n8n workflows and endpoints."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ab4e005b",
   "metadata": {},
   "outputs": [],
   "source": [
    "def test_webhook(webhook_url, payload=None):\n",
    "    \"\"\"Test a webhook endpoint\"\"\"\n",
    "    try:\n",
    "        payload = payload or {\"test\": True, \"timestamp\": datetime.now().isoformat()}\n",
    "        response = requests.post(webhook_url, json=payload)\n",
    "        return {\n",
    "            'Status Code': response.status_code,\n",
    "            'Response': response.text,\n",
    "            'Headers': dict(response.headers)\n",
    "        }\n",
    "    except Exception as e:\n",
    "        return {'Error': str(e)}\n",
    "\n",
    "# Create webhook testing interface\n",
    "webhook_url_input = widgets.Text(\n",
    "    description='Webhook URL:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "payload_input = widgets.Textarea(\n",
    "    description='Payload (JSON):',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'},\n",
    "    value='{}'\n",
    ")\n",
    "\n",
    "def test_webhook_button_clicked(button):\n",
    "    try:\n",
    "        payload = json.loads(payload_input.value)\n",
    "    except:\n",
    "        print(\"‚ùå Invalid JSON payload\")\n",
    "        return\n",
    "    \n",
    "    clear_output(wait=True)\n",
    "    print(\"üîÑ Testing webhook...\")\n",
    "    result = test_webhook(webhook_url_input.value, payload)\n",
    "    print(\"\\nResults:\")\n",
    "    print(json.dumps(result, indent=2))\n",
    "\n",
    "test_button = widgets.Button(\n",
    "    description='Test Webhook',\n",
    "    button_style='primary'\n",
    ")\n",
    "test_button.on_click(test_webhook_button_clicked)\n",
    "\n",
    "# Display testing interface\n",
    "display(webhook_url_input)\n",
    "display(payload_input)\n",
    "display(test_button)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "92085439",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_workflows():\n",
    "    \"\"\"Fetch all workflows from n8n\"\"\"\n",
    "    try:\n",
    "        response = requests.get(\n",
    "            f\"{N8N_URL}/api/v1/workflows\",\n",
    "            headers={'X-N8N-API-KEY': N8N_API_KEY}\n",
    "        )\n",
    "        return response.json() if response.status_code == 200 else []\n",
    "    except:\n",
    "        return []\n",
    "\n",
    "def display_workflows():\n",
    "    \"\"\"Display workflows in a formatted table\"\"\"\n",
    "    workflows = get_workflows()\n",
    "    if not workflows:\n",
    "        return pd.DataFrame(columns=['ID', 'Name', 'Status', 'Last Updated'])\n",
    "    \n",
    "    workflow_data = []\n",
    "    for wf in workflows:\n",
    "        workflow_data.append({\n",
    "            'ID': wf.get('id'),\n",
    "            'Name': wf.get('name'),\n",
    "            'Status': 'üü¢ Active' if wf.get('active') else '‚ö´ Inactive',\n",
    "            'Last Updated': datetime.fromisoformat(wf.get('updatedAt')).strftime('%Y-%m-%d %H:%M')\n",
    "        })\n",
    "    \n",
    "    return pd.DataFrame(workflow_data)\n",
    "\n",
    "# Display workflows\n",
    "display_workflows()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "22dabb64",
   "metadata": {},
   "source": [
    "## 3. Workflow Management\n",
    "\n",
    "Monitor and manage your n8n workflows."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "242d79d4",
   "metadata": {},
   "outputs": [],
   "source": [
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output\n",
    "\n",
    "# Create input widgets for configuration\n",
    "n8n_url_input = widgets.Text(\n",
    "    value=N8N_URL,\n",
    "    description='N8N URL:',\n",
    "    style={'description_width': 'initial'}\n",
    ")\n",
    "\n",
    "api_key_input = widgets.Password(\n",
    "    value=N8N_API_KEY,\n",
    "    description='API Key:',\n",
    "    style={'description_width': 'initial'}\n",
    ")\n",
    "\n",
    "def update_config(button):\n",
    "    global N8N_URL, N8N_API_KEY\n",
    "    N8N_URL = n8n_url_input.value\n",
    "    N8N_API_KEY = api_key_input.value\n",
    "    clear_output()\n",
    "    print(\"‚úÖ Configuration updated successfully!\")\n",
    "    display_system_status()\n",
    "\n",
    "update_button = widgets.Button(\n",
    "    description='Update Configuration',\n",
    "    button_style='primary'\n",
    ")\n",
    "update_button.on_click(update_config)\n",
    "\n",
    "# Display configuration widgets\n",
    "display(n8n_url_input)\n",
    "display(api_key_input)\n",
    "display(update_button)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7b6ce066",
   "metadata": {},
   "source": [
    "## 2. System Health Check\n",
    "\n",
    "Monitor system resources and container health:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a24db458",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create authentication widgets\n",
    "n8n_url = widgets.Text(\n",
    "    value='https://dispatch-pipeline.fly.dev',\n",
    "    description='N8N URL:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "username = widgets.Text(\n",
    "    value='admin',\n",
    "    description='Username:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "password = widgets.Password(\n",
    "    description='Password:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '50%'}\n",
    ")\n",
    "\n",
    "test_auth_button = widgets.Button(\n",
    "    description='Test Connection',\n",
    "    button_style='info'\n",
    ")\n",
    "\n",
    "auth_output = widgets.Output()\n",
    "\n",
    "def test_auth(b):\n",
    "    with auth_output:\n",
    "        clear_output()\n",
    "        try:\n",
    "            response = requests.get(\n",
    "                f\"{n8n_url.value}/healthz\",\n",
    "                auth=(username.value, password.value),\n",
    "                timeout=5\n",
    "            )\n",
    "            if response.status_code == 200:\n",
    "                print(\"‚úÖ Connection successful!\")\n",
    "            else:\n",
    "                print(f\"‚ùå Connection failed! Status code: {response.status_code}\")\n",
    "        except Exception as e:\n",
    "            print(f\"‚ùå Error connecting to n8n: {str(e)}\")\n",
    "\n",
    "test_auth_button.on_click(test_auth)\n",
    "\n",
    "# Display widgets\n",
    "display(n8n_url, username, password, test_auth_button, auth_output)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e0ac347d",
   "metadata": {},
   "source": [
    "## 1. Authentication and Connection Settings\n",
    "\n",
    "Enter your n8n credentials and connection details:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d19d754b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Import required libraries\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output\n",
    "import requests\n",
    "import json\n",
    "import psutil\n",
    "import pandas as pd\n",
    "import plotly.express as px\n",
    "import plotly.graph_objects as go\n",
    "from datetime import datetime\n",
    "import os\n",
    "import re"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "10e70c22",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Install required packages\n",
    "%pip install ipywidgets requests psutil pandas plotly pymongo"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d425ad77",
   "metadata": {},
   "source": [
    "# N8N Admin Dashboard\n",
    "\n",
    "This notebook provides a comprehensive admin dashboard for monitoring and managing your n8n deployment. Use the sections below to:\n",
    "- Check system health\n",
    "- Validate credentials and connections\n",
    "- Monitor API endpoints\n",
    "- Analyze logs\n",
    "- Track user activity\n",
    "\n",
    "First, let's install the required packages:"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d85a3646",
   "metadata": {},
   "source": [
    "## Workflow Control Panel\n",
    "\n",
    "This section provides direct control over N8N workflows:\n",
    "- Lists all active workflows\n",
    "- Allows selection of specific workflows\n",
    "- Enables immediate activation/deactivation of workflows\n",
    "- Shows current status of selected workflow\n",
    "\n",
    "‚ö†Ô∏è **Important**: Use these controls with caution as they directly affect production workflows."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "34e3dcae",
   "metadata": {},
   "outputs": [],
   "source": [
    "def get_all_workflows():\n",
    "    \"\"\"Fetch all workflows from N8N API\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{n8n_url}/api/v1/workflows\", headers=headers)\n",
    "        response.raise_for_status()\n",
    "        return response.json()\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        print(f\"Error fetching workflows: {str(e)}\")\n",
    "        return []\n",
    "\n",
    "def update_workflow_status(workflow_id, active):\n",
    "    \"\"\"Update the active status of a workflow\"\"\"\n",
    "    try:\n",
    "        endpoint = f\"{n8n_url}/api/v1/workflows/{workflow_id}/activate\" if active else f\"{n8n_url}/api/v1/workflows/{workflow_id}/deactivate\"\n",
    "        response = requests.post(endpoint, headers=headers)\n",
    "        response.raise_for_status()\n",
    "        return True\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        print(f\"Error updating workflow status: {str(e)}\")\n",
    "        return False\n",
    "\n",
    "# Create widgets for workflow control\n",
    "workflow_dropdown = widgets.Dropdown(\n",
    "    description='Workflow:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout=widgets.Layout(width='50%')\n",
    ")\n",
    "\n",
    "status_label = widgets.HTML(\n",
    "    value='<span style=\"color: gray;\">No workflow selected</span>'\n",
    ")\n",
    "\n",
    "toggle_button = widgets.ToggleButton(\n",
    "    value=False,\n",
    "    description='Inactive',\n",
    "    button_style='danger',\n",
    "    tooltip='Toggle workflow active status',\n",
    "    icon='power-off',\n",
    "    layout=widgets.Layout(width='150px')\n",
    ")\n",
    "\n",
    "def update_workflow_list(*_):\n",
    "    \"\"\"Update the workflow dropdown with current workflows\"\"\"\n",
    "    workflows = get_all_workflows()\n",
    "    workflow_dropdown.options = [(f\"{w['name']} (ID: {w['id']})\", w['id']) for w in workflows]\n",
    "    workflow_dropdown.value = None\n",
    "    toggle_button.value = False\n",
    "    status_label.value = '<span style=\"color: gray;\">No workflow selected</span>'\n",
    "\n",
    "def on_workflow_select(change):\n",
    "    \"\"\"Handle workflow selection\"\"\"\n",
    "    if change['new'] is None:\n",
    "        toggle_button.value = False\n",
    "        status_label.value = '<span style=\"color: gray;\">No workflow selected</span>'\n",
    "        return\n",
    "    \n",
    "    workflows = get_all_workflows()\n",
    "    selected = next((w for w in workflows if w['id'] == change['new']), None)\n",
    "    if selected:\n",
    "        toggle_button.value = selected.get('active', False)\n",
    "        toggle_button.description = 'Active' if toggle_button.value else 'Inactive'\n",
    "        toggle_button.button_style = 'success' if toggle_button.value else 'danger'\n",
    "        status = 'active' if toggle_button.value else 'inactive'\n",
    "        status_label.value = f'<span style=\"color: {\"green\" if toggle_button.value else \"red\"}\">Status: {status}</span>'\n",
    "\n",
    "def on_toggle(change):\n",
    "    \"\"\"Handle workflow activation/deactivation\"\"\"\n",
    "    if workflow_dropdown.value is None:\n",
    "        return\n",
    "    \n",
    "    success = update_workflow_status(workflow_dropdown.value, change['new'])\n",
    "    if success:\n",
    "        toggle_button.description = 'Active' if change['new'] else 'Inactive'\n",
    "        toggle_button.button_style = 'success' if change['new'] else 'danger'\n",
    "        status = 'active' if change['new'] else 'inactive'\n",
    "        status_label.value = f'<span style=\"color: {\"green\" if change[\"new\"] else \"red\"}\">Status: {status}</span>'\n",
    "    else:\n",
    "        # Revert the toggle if update failed\n",
    "        toggle_button.value = not change['new']\n",
    "\n",
    "# Wire up the event handlers\n",
    "workflow_dropdown.observe(on_workflow_select, names='value')\n",
    "toggle_button.observe(on_toggle, names='value')\n",
    "\n",
    "# Create refresh button\n",
    "refresh_button = widgets.Button(\n",
    "    description='Refresh List',\n",
    "    icon='sync',\n",
    "    tooltip='Refresh workflow list',\n",
    "    layout=widgets.Layout(width='150px')\n",
    ")\n",
    "refresh_button.on_click(update_workflow_list)\n",
    "\n",
    "# Create the control panel layout\n",
    "controls = widgets.VBox([\n",
    "    widgets.HBox([workflow_dropdown, refresh_button], layout=widgets.Layout(align_items='center')),\n",
    "    widgets.HBox([toggle_button, status_label], layout=widgets.Layout(align_items='center', padding='10px 0'))\n",
    "])\n",
    "\n",
    "# Initial population of workflow list\n",
    "update_workflow_list()\n",
    "\n",
    "# Display the control panel\n",
    "display(controls)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f1b2a302",
   "metadata": {},
   "source": [
    "## System Status Verification\n",
    "\n",
    "Execute the following cell to verify the N8N deployment status and API connectivity:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7be790f3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Install tabulate if missing\n",
    "%pip install tabulate\n",
    "\n",
    "# System Status Verification Code\n",
    "# This code confirms N8N is responding and that the API key works (accessing the database).\n",
    "\n",
    "def check_n8n_status(url):\n",
    "    \"\"\"Check if n8n is accessible and running\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{url}/healthz\", timeout=5)\n",
    "        return response.status_code == 200, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database(url, api_key):\n",
    "    \"\"\"Check database connection via API key access\"\"\"\n",
    "    if not api_key:\n",
    "        return False, \"API Key is not set.\"\n",
    "    try:\n",
    "        response = requests.get(f\"{url}/api/v1/workflows?limit=1\",\n",
    "                                headers={'X-N8N-API-KEY': api_key}, timeout=5)\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working (Workflows accessible)\"\n",
    "        elif response.status_code == 401:\n",
    "            return False, \"API Key Unauthorized (401)\"\n",
    "        return False, f\"API check failed: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "# --- Execute Verification ---\n",
    "print(\"\\n--- System Status Verification ---\")\n",
    "\n",
    "# Get current configuration from global variables\n",
    "n8n_url = N8N_URL\n",
    "api_key = N8N_API_KEY\n",
    "\n",
    "n8n_status, n8n_msg = check_n8n_status(n8n_url)\n",
    "db_status, db_msg = check_database(n8n_url, api_key)\n",
    "\n",
    "status_df = pd.DataFrame({\n",
    "    'Component': ['N8N Service', 'Persistence (DB)'],\n",
    "    'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "               'üü¢ Connected' if db_status else 'üî¥ Disconnected'],\n",
    "    'Message': [n8n_msg, db_msg]\n",
    "})\n",
    "\n",
    "print(\"\\nStatus Report:\")\n",
    "print(\"=============\")\n",
    "print(status_df.to_markdown(index=False))\n",
    "\n",
    "# Print overall status\n",
    "if n8n_status and db_status:\n",
    "    print(\"\\n‚úÖ All systems operational!\")\n",
    "else:\n",
    "    print(\"\\n‚ùå Some components are not functioning correctly. Please check the status report above.\")\n",
    "\n",
    "---\n",
    "\n",
    "<a id=\"config\"></a>\n",
    "## ‚öôÔ∏è Step 2: Configuration\n",
    "\n",
    "**Status**: üîß Configure your n8n connection\n",
    "\n",
    "### üìù Instructions:\n",
    "1. **N8N URL**: Enter your n8n instance URL (e.g., `https://n8n-dispatch.fly.dev`)\n",
    "2. **API Key**: Create one in n8n Settings ‚Üí API ‚Üí Add API Key\n",
    "3. **Click \"Test Connection\"** to verify everything works\n",
    "4. **Success = Green checkmark** ‚úÖ\n",
    "\n",
    "**üí° Need an API Key?**\n",
    "- Go to your n8n dashboard\n",
    "- Settings ‚Üí API ‚Üí Add API Key\n",
    "- Name it something like \"admin_dashboard\"\n",
    "- Copy the generated key (you won't see it again!)\n",
    "\n",
    "---\n",
    "\n",
    "**üîó Current Configuration:**\n",
    "- URL: `{N8N_URL}`\n",
    "- API Key: `{'‚úÖ Configured' if N8N_API_KEY else '‚ùå Not configured'}`"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2c7b41ec",
   "metadata": {},
   "source": [
    "## System Status Check\n",
    "\n",
    "The following cell implements health checks for the n8n instance and database connection:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ccf82dd3",
   "metadata": {},
   "outputs": [],
   "source": [
    "def check_n8n_status():\n",
    "    \"\"\"Check if n8n is accessible and running\"\"\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/healthz\", timeout=5)\n",
    "        if response.status_code == 200:\n",
    "            return True, \"N8N is running normally\"\n",
    "        return False, f\"N8N returned status code: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error connecting to N8N: {str(e)}\"\n",
    "\n",
    "def check_database():\n",
    "    \"\"\"Check database connection via API key access\"\"\"\n",
    "    if not N8N_API_KEY:\n",
    "        return False, \"API Key is not set.\"\n",
    "    try:\n",
    "        response = requests.get(f\"{N8N_URL}/api/v1/workflows?limit=1\", \n",
    "                                headers={'X-N8N-API-KEY': N8N_API_KEY}, timeout=5)\n",
    "        \n",
    "        if response.status_code == 200:\n",
    "            return True, \"Database connection is working (Workflows accessible)\"\n",
    "        elif response.status_code == 401:\n",
    "            return False, \"API Key Unauthorized (401)\"\n",
    "        return False, f\"API check failed: {response.status_code}\"\n",
    "    except requests.exceptions.RequestException as e:\n",
    "        return False, f\"Error checking database: {str(e)}\"\n",
    "\n",
    "def display_system_status():\n",
    "    \"\"\"Display system status in a formatted way\"\"\"\n",
    "    n8n_status, n8n_msg = check_n8n_status()\n",
    "    db_status, db_msg = check_database()\n",
    "    \n",
    "    status_df = pd.DataFrame({\n",
    "        'Component': ['N8N Service', 'Persistence (DB)'],\n",
    "        'Status': ['üü¢ Online' if n8n_status else 'üî¥ Offline',\n",
    "                   'üü¢ Connected' if db_status else 'üî¥ Disconnected'],\n",
    "        'Message': [n8n_msg, db_msg]\n",
    "    })\n",
    "    \n",
    "    display(status_df)\n",
    "    return status_df\n",
    "\n",
    "# Run initial status check\n",
    "display_system_status()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fdbadd24",
   "metadata": {},
   "source": [
    "## Configuration Manager\n",
    "\n",
    "Update your n8n configuration settings:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "41685abc",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create input widgets for configuration\n",
    "n8n_url_input = widgets.Text(\n",
    "    value=N8N_URL,\n",
    "    description='N8N URL:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%'}\n",
    ")\n",
    "\n",
    "api_key_input = widgets.Password(\n",
    "    value=N8N_API_KEY,\n",
    "    description='API Key:',\n",
    "    style={'description_width': 'initial'},\n",
    "    layout={'width': '80%'}\n",
    ")\n",
    "\n",
    "config_output = widgets.Output()\n",
    "\n",
    "def update_config(button):\n",
    "    global N8N_URL, N8N_API_KEY\n",
    "    with config_output:\n",
    "        clear_output(wait=True)\n",
    "        N8N_URL = n8n_url_input.value\n",
    "        N8N_API_KEY = api_key_input.value\n",
    "        print(\"‚úÖ Configuration updated successfully!\")\n",
    "        print(\"\\nVerifying connection...\")\n",
    "        display_system_status()\n",
    "\n",
    "update_button = widgets.Button(\n",
    "    description='Update Configuration',\n",
    "    button_style='primary'\n",
    ")\n",
    "update_button.on_click(update_config)\n",
    "\n",
    "# Display configuration widgets\n",
    "display(widgets.VBox([\n",
    "    n8n_url_input,\n",
    "    api_key_input,\n",
    "    update_button,\n",
    "    config_output\n",
    "]))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "82fa12d0",
   "metadata": {},
   "source": [
    "# üéâ Dashboard Summary & Next Steps {#summary}\n",
    "\n",
    "**Congratulations!** You've successfully set up and explored your N8N Admin Dashboard.\n",
    "\n",
    "## üìä Current System Status\n",
    "\n",
    "### ‚úÖ **Operational Status: PRODUCTION READY**\n",
    "- **N8N Service**: üü¢ Online and healthy\n",
    "- **Security**: üü¢ Hardened (environment access blocked, file access restricted)\n",
    "- **Monitoring**: üü¢ Active (concurrency watchdog, health checks, error diagnostics)\n",
    "- **Infrastructure**: üü¢ Complete (Fly.io deployment, persistent volumes, health checks)\n",
    "\n",
    "### ‚ö†Ô∏è **Persistence Status: FRAGILE (SQLite)**\n",
    "- **Database**: üü° SQLite (optimized with WAL mode, vacuum operations)\n",
    "- **Concurrency Limit**: 10-15 concurrent writers maximum\n",
    "- **Risk**: High-load failure possible under concurrent workflow execution\n",
    "- **Migration**: PostgreSQL cluster ready (`n8n-db-pristine` - 3/3 healthy instances)\n",
    "\n",
    "## üõ†Ô∏è **Mandatory Next Step: PostgreSQL Migration Planning**\n",
    "\n",
    "**The system is production-authorized but not resilient to high-load failure.** The SQLite core remains the single point of fragility.\n",
    "\n",
    "### **Migration Strategy: Scheduled Maintenance (Not Emergency)**\n",
    "1. **Postgres Cluster Status**: ‚úÖ **VERIFIED HEALTHY**\n",
    "   - Primary + 2 replicas in London region\n",
    "   - All health checks passing (3/3)\n",
    "   - Ready for data migration\n",
    "\n",
    "2. **Migration Preparation Required**:\n",
    "   - Configure N8N for Postgres connection credentials\n",
    "   - Identify migration tool (N8N CLI export/import or custom script)\n",
    "   - Plan data transfer: workflows, credentials, execution history\n",
    "   - Schedule maintenance window for zero-downtime migration\n",
    "\n",
    "3. **Trigger Condition**: Monitor concurrency levels\n",
    "   - Current threshold: Alert at 8+ concurrent workflows\n",
    "   - Migration trigger: Consistent high concurrency or business growth\n",
    "\n",
    "## üéØ **Immediate Actions Completed**\n",
    "- ‚úÖ N8N deployment and configuration\n",
    "- ‚úÖ Security hardening implementation\n",
    "- ‚úÖ Proactive monitoring setup\n",
    "- ‚úÖ Concurrency watchdog deployment\n",
    "- ‚úÖ Postgres cluster health verification\n",
    "- ‚úÖ Production readiness confirmation\n",
    "\n",
    "## Mandatory Migration Procedure: SQLite to Postgres üéØ\n",
    "\n",
    "**EXECUTE THIS PROCEDURE when the Concurrency Watchdog hits üü° YELLOW (5-7 concurrent) or üî¥ RED (8+ concurrent) threshold.**\n",
    "\n",
    "### I. Pre-Migration Halt (Zero-Downtime Preparation)\n",
    "\n",
    "1. **Halt the Application:** Stop the N8N application machine to ensure no new data is written to the SQLite file during the transfer, preventing corruption.\n",
    "   ```bash\n",
    "   fly machine stop $(fly machine list -a n8n-clean-deploy -j | jq -r '.[0].id')\n",
    "   ```\n",
    "\n",
    "2. **Verify Stop:** Run `fly status` to confirm the main N8N machine is fully stopped.\n",
    "\n",
    "### II. Data Migration (Transfer Phase)\n",
    "\n",
    "1. **Launch Migration Machine:** Launch a new, temporary container using the N8N Docker image but override the default command to perform a one-time database migration.\n",
    "\n",
    "   *CRITICAL: This assumes the `DATABASE_URL` secret is correctly set on the `n8n-clean-deploy` app and the SQLite data file is accessible.*\n",
    "\n",
    "   ```bash\n",
    "   fly machine run \\\n",
    "       n8nio/n8n:latest \\\n",
    "       --app n8n-clean-deploy \\\n",
    "       --region lhr \\\n",
    "       --vm-memory 1024 \\\n",
    "       --rm \\\n",
    "       --entrypoint n8n \\\n",
    "       -- \\\n",
    "       migration:run\n",
    "   ```\n",
    "\n",
    "   *The `--rm` flag ensures the temporary machine is destroyed immediately after the command completes.*\n",
    "\n",
    "### III. Post-Migration Verification and Final State\n",
    "\n",
    "1. **Start Production Machine:** Restart the N8N application machine. It will automatically detect the Postgres tables and permanently switch its persistence to the remote cluster.\n",
    "\n",
    "   ```bash\n",
    "   fly machine start $(fly machine list -a n8n-clean-deploy -s stopped -j | jq -r '.[0].id')\n",
    "   ```\n",
    "\n",
    "2. **Final Verification:** Check the application logs. The logs must not show the old SQLite deprecation warnings. Instead, they should show N8N initializing the Postgres connection.\n",
    "\n",
    "   ```bash\n",
    "   fly logs\n",
    "   ```\n",
    "\n",
    "3. **Cleanup SQLite:** Once verified, the old SQLite file in the container volume is useless and must be removed to prevent future confusion.\n",
    "\n",
    "   *Note: Since the final architecture uses Postgres secrets, N8N will ignore the SQLite file. Removal is a final layer of cleanup only.*\n",
    "\n",
    "## üìà **Business Impact**\n",
    "- **Current**: Fully operational dispatch pipeline\n",
    "- **Risk**: SQLite concurrency limits under high load\n",
    "- **Mitigation**: Scheduled PostgreSQL migration when concurrency thresholds reached\n",
    "- **Confidence**: System failure prevention through monitoring\n",
    "\n",
    "**The operational lifecycle is complete. PostgreSQL migration is scheduled maintenance, not panic response.**"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.1"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
